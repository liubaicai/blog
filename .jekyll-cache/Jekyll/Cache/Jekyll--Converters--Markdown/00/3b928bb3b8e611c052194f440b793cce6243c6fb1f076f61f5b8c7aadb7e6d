I"‡<p>åŸæ–‡è¯·å‰å¾€<a href="https://robots.thoughtbot.com/lets-build-a-sinatra" target="_blank">Letâ€™s Build Sinatra</a></p>

<p>æ›¾ç»çœ‹è¿‡ä¸€æœ¬ä¹¦<a href="https://rebuilding-rails.com/" target="_blank">ã€ŠRebuilding Own Railsã€‹&lt;/a&gt;ï¼ŒåœŸè±ªè¯·æ”¯æŒä½œè€…ã€‚å¯¹äºä¸­å›½è¯»è€…æ¥è¯´ï¼Œæ­¤ä¹¦ç¡®å®æŒºè´µã€‚</a></p>

<p>çœ‹äº†è¿™ä¸¤æœ¬ä¹¦ä»¥åï¼Œç•¥ä½œæ€»ç»“ï¼Œé¡ºä¾¿å’Œå¤§å®¶åˆ†äº«ä¸€ä¸‹ã€‚</p>
<h2 id="Trick #1 Rack">Trick #1 Rack</h2>
<p>æ— è®ºæ˜¯Railsã€è¿˜æ˜¯Sinatraè¿™äº›åŸºäºRackçš„æ¡†æ¶ï¼ŒåŸç†éƒ½æ˜¯è°ƒç”¨Rackçš„callå‡½æ•°ï¼Œæ­¤å‡½æ•°æ¥å—ä¸€ä¸ªå‚æ•°ï¼Œenvã€‚
Rackçš„åŸºæœ¬åŸç†ï¼Œæ˜¯æŠŠå¯¹Rackå¯¹è±¡å‘é€HTTPè¯·æ±‚çš„â€œç¯å¢ƒâ€œï¼Œ å˜é‡envï¼Œä½œä¸ºå‚æ•°æ¥è°ƒç”¨callæ–¹æ³•ï¼Œç„¶åæŠŠè¿”å›å€¼å½“ä½œæ˜¯å¯¹è¯·æ±‚çš„å›åº”ã€‚
åœ¨æˆ‘ä»¬ç”Ÿæˆçš„Railsåº”ç”¨ç¨‹åºé‡Œé¢ï¼Œæœ‰ä¸ªæ–‡ä»¶&lt;strong&gt;config.ru&lt;/strong&gt;ï¼Œè¿™ä¸ªæ–‡ä»¶å°±æ˜¯ä¸ºRackå‡†å¤‡çš„ã€‚
æˆ‘ä»¬å¯ä»¥è¯•è¯•å¦‚ä¸‹ä»£ç (èŠ‚é€‰è‡³ã€Šä»£ç çš„æœªæ¥ã€‹ï¼Œ210é¡µ)ï¼š</p>
<pre class="lang:ruby decode:true "># hello.rb
class HelloApp
   def call(env)
       [ 200,                                  # ä¾æ¬¡æ˜¯ HTTP çŠ¶æ€ç ï¼Œ200è¡¨ç¤ºæˆåŠŸï¼›
         {"Content-Type" =&gt; "text/plain"},    #  HTTP å“åº”å¤´éƒ¨ï¼ˆå³HTMLæ–‡ä»¶ä¸­headeréƒ¨åˆ†ï¼‰ï¼Œæ”¾åœ¨Hashä¸­ï¼›
         ["Hello, Rack World!"]              # HTTP å“åº”ä¸»ä½“ï¼ˆå³HTMLæ–‡ä»¶ä¸­bodyéƒ¨åˆ†ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬æ‰“å¼€æµè§ˆå™¨çœ‹åˆ°çš„å†…å®¹ï¼‰
                                                  #å¿…é¡»æ˜¯å­—ç¬¦ä¸²æ•°ç»„ã€‚ï¼ˆä¸ºä»€ä¹ˆæ˜¯å­—ç¬¦ä¸²æ•°ç»„ï¼Œè€Œä¸æ˜¯å­—ç¬¦ä¸²ï¼Ÿï¼‰
       ]       
   end
end</pre>
<p>Â </p>

<p>callå‡½æ•°çš„è¿”å›å€¼ï¼Œæœ€åä¸€ä¸ªbodyéƒ¨åˆ†ï¼Œå› ä¸ºåœ¨Ruby 1.9é‡Œï¼Œå¦‚æœæ˜¯å­—ç¬¦ä¸²ï¼Œå°±ä¼šå¯¼è‡´ç¨‹åºå´©æºƒï¼Œæ‰€ä»¥å¿…é¡»æ˜¯Enumeratorç±»å‹çš„ï¼Œï¼ˆå¯æ¥å—eachæ–¹æ³•ï¼‰ï¼Œå…·ä½“å‰å¾€<a href="http://www.rubydoc.info/github/rack/rack/master/file/SPEC" target="_blank">Rack SPEC</a></p>

<p>å¦å¤–éœ€è¦å‡†å¤‡ä¸€ä¸ªé…ç½®æ–‡ä»¶ï¼Œä»¥&lt;strong&gt;.ru&lt;/strong&gt;ç»“å°¾</p>
<pre class="lang:ruby decode:true"># hello.ru
require  'rubygems'
require 'rack'
require 'hello'

#è‡³ä¸ºå…³é”®çš„ä¸€å¥
run HelloApp.new</pre>
<p>Â </p>

<p>ç„¶ååœ¨å‘½ä»¤è¡Œç»ˆç«¯è¿è¡Œï¼š</p>
<pre class="highlight plaintext"><code>$ rackup hello.ru</code></pre>
<p>åœ¨Railsé¡¹ç›®é‡Œï¼Œç›¸åº”çš„é…ç½®æ–‡ä»¶åä¸º&lt;strong&gt;config.ru&lt;/strong&gt;</p>
<pre class="lang:ruby decode:true "># config.ru

# This file is used by Rack-based servers to start the application.

require ::File.expand_path('../config/environment',  __FILE__)   # åŒ…å«å¯åŠ¨æ–‡ä»¶

run Rails.application  #å¯åŠ¨ç¨‹åº</pre>
<p>Â </p>

<p>å¦‚æœä½ åœ¨Railsåº”ç”¨çš„ç›®å½•ä¸‹è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œä¼šæœ‰å¦‚ä¸‹è¾“å‡ºï¼š</p>
<pre class="highlight plaintext"><code>diancai.in master % rackup config.ru
[2015-10-12 21:36:37] INFO  WEBrick 1.3.1
[2015-10-12 21:36:37] INFO  ruby 2.2.3 (2015-08-18) [x86_64-darwin15]
[2015-10-12 21:36:37] INFO  WEBrick::HTTPServer#start: pid=6490 port=9292</code></pre>
<p>ç¥å¥‡å§ï¼</p>

<p>å¥½äº†ï¼Œè¯´å®ŒRackçš„åŸºç¡€çŸ¥è¯†ï¼Œå†çœ‹çœ‹Sinatraæ˜¯æ€ä¹ˆä½¿ç”¨Rackçš„ã€‚</p>
<h2 id="Trick #2 Application = Sinatra::Base.new">Trick #2 Application = Sinatra::Base.new</h2>
<p>è¿™ä¸ªæ˜¯ç”¨æ¥ç®€åŒ–ä»£ç ï¼Œè®©æ¡†æ¶çœ‹èµ·æ¥æ›´åƒæ˜¯DSLã€‚
ä»¥ä¸‹ä»£ç æ¥è‡ªäº&lt;a href=â€https://robots.thoughtbot.com/lets-build-a-sinatraâ€ target=â€_blankâ€&gt;Letâ€™s Build Sinatra&lt;/a&gt;</p>
<pre class="lang:ruby decode:true ">module Nancy
     class Base
     end

     Application = Base.new
end</pre>
<p>Â </p>

<p>è¿™ä¸ªå…¶å®å¾ˆå®¹æ˜“ç†è§£ï¼Œä½†æ˜¯å¯¹ç®€åŒ–ä»£ç æ¥è¯´ï¼Œä¸å¾—ä¸è¯´æ˜¯ä¸€ä¸ªå·§å¦™çš„è®¾è®¡ã€‚</p>
<h2 id="Trick #3 Delegator">Trick #3 Delegator</h2>
<p>è¿™ä¸€ç‚¹ç¨å¾®æœ‰ç‚¹è®©äººè´¹è§£</p>
<pre class="lang:ruby decode:true ">module Nancy
  module Delegator
    def self.delegate(*methods, to:)
      Array(methods).each do |method_name|
        define_method(method_name) do |*args, &amp;block|
          to.send(method_name, *args, &amp;block)
        end

        private method_name
      end
    end

    delegate :get, :patch, :put, :post, :delete, :head, to: Application
  end
end</pre>
<p>Â </p>

<p>è¿™æ®µä»£ç é‡‡ç”¨å…ƒç¼–ç¨‹çš„æŠ€æœ¯ï¼Œè®©æˆ‘ä»¬åœ¨è°ƒç”¨å‡½æ•°æ—¶ä¸å¿…è¿™æ ·å†™ï¼š</p>
<pre class="highlight ruby"><code><span class="no">Application</span><span class="p">.</span><span class="nf">get</span> <span class="s2">"/"</span><span class="p">,</span> <span class="p">{}</span></code></pre>
<p>è€Œå¯ä»¥ç›´æ¥å†™æˆ</p>
<pre class="highlight ruby"><code>
<span class="n">get</span> <span class="s1">'/'</span><span class="p">,</span> <span class="p">{}</span></code></pre>
<p>ä¸Šé¢çš„ä»£ç åˆ©ç”¨define_methodåŠ¨æ€å®šä¹‰äº†:get, :patchç­‰ï¼Œè€Œä¸”æŠŠè¿™äº›æ–¹æ³•ä½œä¸ºApplication ï¼ˆå³ï¼šNancy::Base.newå®ä¾‹çš„å®ä¾‹æ–¹æ³•ï¼‰ã€‚</p>

<p>å®ƒçš„çœŸæ­£çš„trickåœ¨äºï¼Œåœ¨åˆ©ç”¨è¿™ä¸ªæ¡†æ¶ï¼Œå†™çš„åº”ç”¨ç¨‹åºï¼Œ å¦‚ï¼š</p>
<pre class="lang:ruby decode:true "># app.rb
# run with `ruby app.rb`
require "./nancy"

get "/" do
  "Hey there!"
end</pre>
<p>Â </p>

<p>ä¸­ï¼Œè¡¨é¢ä¸Šå¥½åƒç›´æ¥è°ƒç”¨Objectçš„getæ–¹æ³•ï¼Œäºæ˜¯ä½ æŸ¥çœ‹æ‰€æœ‰rubyæ–‡æ¡£ä¹Ÿæ²¡æœ‰getè¿™ä¸ªæ–¹æ³•ï¼Œä½ å¯èƒ½æœ‰ç‚¹å´©æºƒäº†ï¼Œä¸çŸ¥é“å®ƒæ˜¯æ¥è‡ªäºé‚£é‡Œï¼Œå¹²ä»€ä¹ˆç”¨çš„ã€‚
å…¶å®ï¼Œå°±æ˜¯å› ä¸ºåœ¨<strong>nancy.rb</strong>é‡Œé¢æœ‰ä¸€å¥&lt;code&gt;include Nancy::Delegator&lt;/code&gt;, æˆ‘ä»¬æŠŠ&lt;code&gt;get&lt;/code&gt;æ–¹æ³•è¡¥å…¨ï¼Œå°±ä¸€ä¸‹çœ‹æ˜ç™½è¿™ä¸ªæ•…æ„è®¾è®¡çš„trickï¼›</p>
<pre class="lang:ruby decode:true "># app.rb
# run with `ruby app.rb`
require "./nancy"

Nancy::Application.get "/" do
  "Hey there!"
end</pre>
<p>Â </p>

<p>æˆ–è€…æ›´è¿‘ä¸€æ­¥ï¼š</p>
<pre class="lang:ruby decode:true "># app.rb
# run with `ruby app.rb`
require "./nancy"

Nancy::Base.new.get "/" do
  "Hey there!"
end</pre>
<p>Â </p>

<p>è¿™æ ·å†™ï¼Œå°±æ¸…æ¥šæ˜äº†äº†ï¼Œä½†æ˜¯å¯èƒ½å†™ä¸¤å¥ä½ å°±å¾ˆä¸ä¹æ„äº†ã€‚</p>

<p>æ€»ç»“ï¼Œæ— è®ºæ˜¯Railsï¼Œè¿˜æ˜¯Sinatraï¼Œåœ¨ä½¿ç”¨äº†è¿™äº›å…ƒç¼–ç¨‹æŠ€æœ¯ä¹‹åï¼Œè®©æˆ‘ä»¬çš„ä»£ç æ›´åŠ ç®€æ´ï¼Œä¹Ÿè®©æˆ‘ä»¬å¯¹äºä»£ç æ‰€è¦å®Œæˆçš„ä»»åŠ¡æ›´åŠ æ¸…æ™°æ˜äº†ã€‚</p>
:ET