I"ŠĞ<div id="content">
<p><video poster="http://7xp2m5.com2.z0.glb.qiniucdn.com/%22Pinterest%22%20with%20Qiniu%20and%20Rails%20in%2015%20minutes.png" controls="" preload="metadata" height="500" width="600"></video>&lt;source type="video/mp4; codecs="avc1.42E01E, mp4a.40.2"" src="http://7xp2m5.com2.z0.glb.qiniucdn.com/%22Pinterest%22%20with%20Qiniu%20and%20Rails%20in%2015%20minutes.mp4"&gt;</p>
<p>åå¹´å‰ï¼ŒWeb åº”ç”¨æ¡†æ¶ Rails åˆ›å§‹äºº David Heinemeier Hansson æ›¾å½•åˆ¶è§†é¢‘ï¼Œå‘æˆ‘ä»¬æ¼”ç¤ºå¦‚ä½•ä½¿ç”¨ Ruby on Rails åœ¨ 15 åˆ†é’Ÿå†…åˆ›ä½œä¸€ä¸ª blog å¼•æ“ã€‚è¿™ä¸ªè§†é¢‘é€šè¿‡ Rails ä¼˜ç§€çš„ MVC ã€ä¹ æƒ¯ä¼˜äºé…ç½®ï¼ˆConvention over Configurationï¼‰ç­‰è®¾è®¡ï¼Œä»¥åŠå¼ºå¤§çš„ä»£ç ç”Ÿæˆã€scaffold ç­‰åŠŸèƒ½ï¼ŒæˆåŠŸå±•ç¤ºäº† Ruby on Rails ç¼–å†™ Web åº”ç”¨æ ¸å¿ƒåŠŸèƒ½çš„é«˜æ•ˆç®€æ´ã€‚Ruby on Rails è¿™é—¨æŠ€æœ¯ä¹Ÿåœ¨ Web 2.0 æ—¶ä»£å¤§æ”¾å¼‚å½©ï¼Œæˆä¸ºäº† Web åº”ç”¨å¼€å‘æœ€ä½³çš„æŠ€æœ¯æ–¹æ¡ˆé€‰æ‹©ä¹‹ä¸€ã€‚&lt;/p&gt;
<p>ç»è¿‡åå¹´çš„å‘å±•ï¼Œè½¯ä»¶è¡Œä¸šæ—©å·²è¿ˆå…¥äº‘è®¡ç®—æ—¶ä»£ã€‚ä¸ºäº†åº”å¯¹å¤§è§„æ¨¡çš„è®¿é—®é‡ï¼ŒåŒæ—¶æ§åˆ¶ç ”å‘å’Œè¿è¥æˆæœ¬ï¼Œä½œä¸ºäº‘è®¡ç®—åŸºçŸ³çš„äº‘å­˜å‚¨ï¼Œå·²ç»æˆä¸ºäº† Web å¼€å‘å¿…ä¸å¯å°‘çš„åŸºç¡€è®¾æ–½ã€‚ä»Šå¤©ï¼Œå°±è®©æˆ‘ä»¬ä¸€èµ·æ¥çœ‹çœ‹å¦‚ä½•ä½¿ç”¨ Rails å’Œä¸ƒç‰›äº‘å­˜å‚¨ï¼Œåœ¨ 15 åˆ†é’Ÿå†…æ‰“é€ ä¸€ä¸ªå›¾ç‰‡åˆ†äº«ç¤¾äº¤åº”ç”¨åŸå‹ã€‚&lt;/p&gt;
<p><a rel="nofollow" target="_blank" href="http://www.qiniu.com">ä¸ƒç‰›äº‘å­˜å‚¨&lt;/a&gt; æ˜¯ä¸€ä¸ªå…¬æœ‰äº‘æœåŠ¡ï¼Œæä¾›æµ·é‡å¯¹è±¡å­˜å‚¨åŠŸèƒ½ï¼Œä»¥åŠäº‘ç«¯æ–‡ä»¶å¤„ç†å’Œåˆ†å‘æœåŠ¡ã€‚å¼€å§‹ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªä¸ƒç‰›äº‘å­˜å‚¨ <a rel="nofollow" target="_blank" href="https://portal.qiniu.com/signup">è¯•ç”¨å¸æˆ·</a>ï¼Œå¹¶ä¸”äº†è§£ä¸€äº›åŸºç¡€çŸ¥è¯†ï¼š&lt;/p&gt;
<p>ä¸ƒç‰›äº‘å­˜å‚¨æ˜¯ä¸€ä¸ª Key-Value å½¢å¼çš„å¯¹è±¡å­˜å‚¨ç³»ç»Ÿï¼Œä¸€ä¸ª key å¯¹åº”ä¸€ä¸ªèµ„æºï¼ˆæ–‡ä»¶ï¼‰ã€‚&lt;br&gt;
èµ„æºå¿…é¡»å­˜å‚¨åœ¨æŸä¸ªç©ºé—´ï¼ˆBucketï¼‰ä¸­ï¼Œä¸å¯å•ç‹¬å­˜åœ¨ã€‚ä¸€ä¸ªå¸æˆ·å¯ä»¥åˆ›å»ºå¤šä¸ªç©ºé—´ã€‚&lt;/p&gt;
<p>åˆ›å»ºåŸºæœ¬ Rails é¡¹ç›®</p>
<p>ä½ åº”è¯¥å¯ä»¥ä½¿ç”¨ Ruby 1.9 ä»¥ä¸Šï¼ŒRails 3.0 ä»¥ä¸Šçš„ä»»æ„ç‰ˆæœ¬ï¼Œæœ¬ä¾‹ä¸­æˆ‘ä»¬ä½¿ç”¨çš„æ˜¯ Ruby 2.2.3 å’Œ Rails 4.2.5ã€‚&lt;/p&gt;
<p>å®‰è£…å¥½ Ruby å’Œ Rails ä¹‹åï¼Œä½¿ç”¨ rails å‘½ä»¤åˆ›å»ºåº”ç”¨ç¨‹åº konata çš„ç›®å½•ç»“æ„å’ŒåŸºæœ¬æ–‡ä»¶ï¼š&lt;/p&gt;
<p></p><div class="codetitle"><span><a style="CURSOR: pointer" data="48115" class="copybut" id="copybut48115" onclick="doCopy('code48115')"><u>å¤åˆ¶ä»£ç </u></a></span> ä»£ç å¦‚ä¸‹:</div><div class="codebody" id="code48115"><br />
rails new konata<br />
</div><br />
ç¨å€™è¿™æ¡å‘½ä»¤æ‰§è¡Œå®Œæˆï¼Œæˆ‘ä»¬ç«‹å³å¾—åˆ°äº†ä¸€ä¸ªå¯ä»¥è¿è¡Œçš„ç©ºç™½ Rails åº”ç”¨ç¨‹åºï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œå¹¶åœ¨æµè§ˆå™¨ä¸­è®¿é—® http://localhost:3000 æŸ¥çœ‹è¿è¡Œæ•ˆæœï¼š&lt;p&gt;</p>
<p></p><div class="codetitle"><span><a style="CURSOR: pointer" data="39829" class="copybut" id="copybut39829" onclick="doCopy('code39829')"><u>å¤åˆ¶ä»£ç </u></a></span> ä»£ç å¦‚ä¸‹:</div><div class="codebody" id="code39829"><br />
cd konata<br />
rails server<br />
</div><p></p>
<p>ä½¿ç”¨ Rails Scaffold å®ç° CRUD</p>
<p>æˆ‘ä»¬å°†ä½¿ç”¨ Rails çš„ scaffold åŠŸèƒ½ï¼Œç”Ÿæˆç”¨äºå¤„ç†å›¾ç‰‡å‘è¡¨çš„ modelã€controllerã€viewï¼Œä»¥åŠ database migration ç­‰æºä»£ç æ–‡ä»¶ã€‚&lt;/p&gt;
<p></p><div class="codetitle"><span><a style="CURSOR: pointer" data="17802" class="copybut" id="copybut17802" onclick="doCopy('code17802')"><u>å¤åˆ¶ä»£ç </u></a></span> ä»£ç å¦‚ä¸‹:</div><div class="codebody" id="code17802"><br />
rails generate scaffold post title filename qiniu_hash<br />
rake db:migrate<br />
</div><br />
è®¿é—® http://localhost:3000/posts å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬å·²ç»è·å¾—äº† post çš„å®Œæ•´ CRUD åŠŸèƒ½ï¼Œåªæ˜¯æš‚æ—¶è¿˜ä¸èƒ½ä¸Šä¼ å›¾ç‰‡ã€‚&lt;p&gt;</p>
<p>ä½¿ç”¨ä¸ƒç‰› API å®ç°å›¾ç‰‡ä¸Šä¼ </p>
<p>ä¿®æ”¹ Gemfileï¼Œåœ¨å…¶ä¸­åŠ å…¥å¯¹ä¸ƒç‰› Ruby SDK çš„å¼•ç”¨ï¼š</p>
<p></p><div class="codetitle"><span><a style="CURSOR: pointer" data="57323" class="copybut" id="copybut57323" onclick="doCopy('code57323')"><u>å¤åˆ¶ä»£ç </u></a></span> ä»£ç å¦‚ä¸‹:</div><div class="codebody" id="code57323"><br />
gem 'qiniu'<br />
</div><p></p>
<p>æ‰§è¡Œä»¥ä¸‹å‘½ä»¤å®‰è£…ä¸ƒç‰› Ruby SDKã€‚è¿™é‡ŒåŸæœ¬åº”è¯¥æ‰§è¡Œ bundle è¿›è¡Œå®‰è£…ï¼Œä½†ç”±äºä¸ƒç‰› Ruby SDK ä¾èµ–çš„ mime-types ç‰ˆæœ¬è®¾å®šæ¯”è¾ƒä¿å®ˆï¼Œéœ€è¦ä½¿ç”¨ bundle update å‘½ä»¤é™çº§ mime-typesï¼Œè§£å†³ä¾èµ–å†²çªã€‚&lt;/p&gt;
<p></p><div class="codetitle"><span><a style="CURSOR: pointer" data="38761" class="copybut" id="copybut38761" onclick="doCopy('code38761')"><u>å¤åˆ¶ä»£ç </u></a></span> ä»£ç å¦‚ä¸‹:</div><div class="codebody" id="code38761"><br />
bundle update mime-types<br />
</div><p></p>
<p>ç¼–è¾‘ config/secrets.ymlï¼Œåœ¨å…¶ä¸­åŠ å…¥ä¸ƒç‰›äº‘å­˜å‚¨å¸æˆ·çš„å¯†é’¥ï¼š&lt;/p&gt;
<p></p><div class="codetitle"><span><a style="CURSOR: pointer" data="21007" class="copybut" id="copybut21007" onclick="doCopy('code21007')"><u>å¤åˆ¶ä»£ç </u></a></span> ä»£ç å¦‚ä¸‹:</div><div class="codebody" id="code21007"><br />
development:<br />
secret_key_base: &lt;YOUR_SECRET_KEY_BASE&gt;<br />
qiniu_access_key: &lt;YOUR_QINIU_ACCESS_KEY&gt;<br />
qiniu_secret_key: &lt;YOUR_QINIU_SECRET_KEY&gt;<br />
</div><p></p>
<p>åˆ›å»º config/initializers/qiniu.rbï¼Œä½¿ç”¨åˆšæ‰åŠ å…¥çš„å¯†é’¥ä¸ä¸ƒç‰›äº‘å­˜å‚¨æœåŠ¡å™¨å»ºç«‹è¿æ¥ã€‚å†…å®¹å¦‚ä¸‹ï¼š</p>
<div class="jb51code">
<div><div id="highlighter_198413" class="syntaxhighlighter  ruby"><div class="toolbar"><span><a href="#" class="toolbar_item command_help help">?</a></span></div><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="ruby plain">require </code><code class="ruby string">'qiniu'</code></div><div class="line number2 index1 alt1">&nbsp;</div><div class="line number3 index2 alt2"><code class="ruby plain">Qiniu.establish_connection!(</code></div><div class="line number4 index3 alt1"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">access_key: Rails.application.secrets.qiniu_access_key,</code></div><div class="line number5 index4 alt2"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">secret_key: Rails.application.secrets.qiniu_secret_key</code></div><div class="line number6 index5 alt1"><code class="ruby plain">)</code></div></div></td></tr></tbody></table></div></div>
</div>
<p><strong>æ³¨æ„ï¼š&lt;/strong&gt;&lt;/p&gt;
<p>AccessKey å’Œ SecretKey å¿…é¡»ç»å¯¹ä¿å¯†ï¼Œä¸å¯å‡ºç°åœ¨ç”¨æˆ·å¯ä»¥æŸ¥çœ‹çš„ Web å‰ç«¯æºä»£ç é‡Œï¼Œæˆ–æ˜¯ç¼–è¯‘è¿›å®¢æˆ·ç«¯äºŒè¿›åˆ¶ä»£ç ä¸­ã€‚&lt;/p&gt;
<p>ä¸ƒç‰› API æä¾›äº†&lt;a rel="nofollow" target="_blank" href="http://developer.qiniu.com/docs/v6/api/overview/up/upload-models/upload-types.html"&gt;å¤šç§ä¸Šä¼ æ–¹å¼&lt;/a&gt; ä»¥æ»¡è¶³ä¸åŒçš„ä¸šåŠ¡åœºæ™¯éœ€æ±‚ã€‚è¿™é‡Œæˆ‘ä»¬é€‰æ‹©ä½¿ç”¨æœ€æœ‰ä»£è¡¨æ€§ï¼Œä¹Ÿæœ€ç®€å•çš„ HTML è¡¨å•ä¸Šä¼ ï¼‹HTTP 303 é‡å®šå‘è¿”å›çš„æ–¹å¼å®ç°å®¢æˆ·ç«¯æ–‡ä»¶ç›´æ¥ä¸Šä¼ ä¸ƒç‰›äº‘å­˜å‚¨ã€‚è¿™ç§æ–¹æ³•çš„å¥½å¤„æ˜¯å®¢æˆ·ç«¯æ–‡ä»¶æ— éœ€é€šè¿‡ä¸šåŠ¡æœåŠ¡å™¨ï¼ˆapp serverï¼‰ä¸­è½¬ï¼Œæ—¢å¯ä»¥åˆ©ç”¨ä¸ƒç‰›å¼ºå¤§çš„ CDN ä¼˜åŒ–ä¸Šä¼ é€Ÿåº¦åŠæé«˜å¯é æ€§ï¼Œä¹Ÿå¯ä»¥èŠ‚çœä¸šåŠ¡æœåŠ¡å™¨å¸¦å®½ã€‚&lt;/p&gt;
<p>ç¼–è¾‘ app/views/posts/_form.html.erbï¼Œæ ¹æ®ä¸ƒç‰›äº‘å­˜å‚¨ SDK æ„é€ ä¸Šä¼ è¡¨å•ã€‚æ³¨æ„å…¶ä¸­çš„ä¸Šä¼ å‡­è¯å­—æ®µï¼Œæˆ‘ä»¬å°†åœ¨ PostsController é‡Œåˆ›å»ºå®ƒï¼š&lt;/p&gt;
<div class="jb51code">
<div><div id="highlighter_815415" class="syntaxhighlighter  ruby"><div class="toolbar"><span><a href="#" class="toolbar_item command_help help">?</a></span></div><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="ruby plain">&lt;%= form_tag </code><code class="ruby string">'<a href="http://upload.qiniu.com">http://upload.qiniu.com</a>'</code><code class="ruby plain">, multipart: </code><code class="ruby keyword">true</code> <code class="ruby keyword">do</code> <code class="ruby plain">%&gt;</code></div><div class="line number2 index1 alt1"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">&lt;%= hidden_field_tag </code><code class="ruby color2">:token</code><code class="ruby plain">, </code><code class="ruby variable bold">@qiniu_upload_token</code> <code class="ruby plain">%&gt;</code></div><div class="line number3 index2 alt2">&nbsp;</div><div class="line number4 index3 alt1"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">&lt;div </code><code class="ruby keyword">class</code><code class="ruby plain">=</code><code class="ruby string">"field"</code><code class="ruby plain">&gt;</code></div><div class="line number5 index4 alt2"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">&lt;%= label_tag </code><code class="ruby color2">:title</code> <code class="ruby plain">%&gt;&lt;br&gt;</code></div><div class="line number6 index5 alt1"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">&lt;%= text_field_tag </code><code class="ruby string">'x:title'</code> <code class="ruby plain">%&gt;</code></div><div class="line number7 index6 alt2"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">&lt;/div&gt;</code></div><div class="line number8 index7 alt1"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">&lt;div </code><code class="ruby keyword">class</code><code class="ruby plain">=</code><code class="ruby string">"field"</code><code class="ruby plain">&gt;</code></div><div class="line number9 index8 alt2"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">&lt;%= label_tag </code><code class="ruby color2">:image</code> <code class="ruby plain">%&gt;&lt;br&gt;</code></div><div class="line number10 index9 alt1"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">&lt;%= file_field_tag </code><code class="ruby color2">:file</code> <code class="ruby plain">%&gt;</code></div><div class="line number11 index10 alt2"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">&lt;/div&gt;</code></div><div class="line number12 index11 alt1"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">&lt;div </code><code class="ruby keyword">class</code><code class="ruby plain">=</code><code class="ruby string">"actions"</code><code class="ruby plain">&gt;</code></div><div class="line number13 index12 alt2"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">&lt;%= submit_tag </code><code class="ruby string">'Create'</code> <code class="ruby plain">%&gt;</code></div><div class="line number14 index13 alt1"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">&lt;/div&gt;</code></div><div class="line number15 index14 alt2"><code class="ruby plain">&lt;% </code><code class="ruby keyword">end</code> <code class="ruby plain">%&gt;</code></div></div></td></tr></tbody></table></div></div>
</div>
<p>ç¼–è¾‘ app/controllers/posts_controller.rbï¼Œæ·»åŠ ä»£ç ç”Ÿæˆä¸Šä¼ å‡­è¯ï¼Œä»¥åŠæ ¹æ®ä¸ƒç‰›äº‘å­˜å‚¨è‡ªå®šä¹‰å“åº”å†…å®¹åˆ›å»º post å®ä¾‹ï¼š&lt;/p&gt;
<div class="jb51code">
<div><div id="highlighter_708779" class="syntaxhighlighter  ruby"><div class="toolbar"><span><a href="#" class="toolbar_item command_help help">?</a></span></div><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div><div class="line number17 index16 alt2">17</div><div class="line number18 index17 alt1">18</div><div class="line number19 index18 alt2">19</div><div class="line number20 index19 alt1">20</div><div class="line number21 index20 alt2">21</div><div class="line number22 index21 alt1">22</div><div class="line number23 index22 alt2">23</div><div class="line number24 index23 alt1">24</div><div class="line number25 index24 alt2">25</div><div class="line number26 index25 alt1">26</div><div class="line number27 index26 alt2">27</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="ruby keyword">def</code> <code class="ruby keyword">new</code></div><div class="line number2 index1 alt1"><code class="ruby spaces">&nbsp;</code><code class="ruby variable bold">@qiniu_upload_token</code> <code class="ruby plain">= generate_qiniu_upload_token</code></div><div class="line number3 index2 alt2"><code class="ruby spaces">&nbsp;</code><code class="ruby variable bold">@post</code> <code class="ruby plain">= Post.</code><code class="ruby keyword">new</code></div><div class="line number4 index3 alt1"><code class="ruby spaces">&nbsp;</code><code class="ruby keyword">end</code></div><div class="line number5 index4 alt2">&nbsp;</div><div class="line number6 index5 alt1"><code class="ruby spaces">&nbsp;</code><code class="ruby keyword">def</code> <code class="ruby plain">create</code></div><div class="line number7 index6 alt2"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">upload_ret = </code><code class="ruby constants">JSON</code><code class="ruby plain">.parse(Base64.urlsafe_decode64(params[</code><code class="ruby color2">:upload_ret</code><code class="ruby plain">]))</code></div><div class="line number8 index7 alt1"><code class="ruby spaces">&nbsp;</code><code class="ruby variable bold">@post</code> <code class="ruby plain">= Post.</code><code class="ruby keyword">new</code><code class="ruby plain">(</code></div><div class="line number9 index8 alt2"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">title: upload_ret[</code><code class="ruby string">'title'</code><code class="ruby plain">],</code></div><div class="line number10 index9 alt1"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">filename: upload_ret[</code><code class="ruby string">'fname'</code><code class="ruby plain">],</code></div><div class="line number11 index10 alt2"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">qiniu_hash: upload_ret[</code><code class="ruby string">'hash'</code><code class="ruby plain">]</code></div><div class="line number12 index11 alt1"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">)</code></div><div class="line number13 index12 alt2"><code class="ruby spaces">&nbsp;</code><code class="ruby comments"># ...</code></div><div class="line number14 index13 alt1"><code class="ruby spaces">&nbsp;</code><code class="ruby keyword">end</code></div><div class="line number15 index14 alt2">&nbsp;</div><div class="line number16 index15 alt1"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">private</code></div><div class="line number17 index16 alt2">&nbsp;</div><div class="line number18 index17 alt1"><code class="ruby spaces">&nbsp;</code><code class="ruby keyword">def</code> <code class="ruby plain">generate_qiniu_upload_token</code></div><div class="line number19 index18 alt2"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">put_policy = Qiniu::Auth::PutPolicy.</code><code class="ruby keyword">new</code><code class="ruby plain">(</code><code class="ruby string">'konata'</code><code class="ruby plain">)</code></div><div class="line number20 index19 alt1"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">put_policy.return_body = {</code></div><div class="line number21 index20 alt2"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">fname: </code><code class="ruby string">'$(fname)'</code><code class="ruby plain">,</code></div><div class="line number22 index21 alt1"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">hash: </code><code class="ruby string">'$(etag)'</code><code class="ruby plain">,</code></div><div class="line number23 index22 alt2"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">title: </code><code class="ruby string">'$(x:title)'</code></div><div class="line number24 index23 alt1"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">}.to_json</code></div><div class="line number25 index24 alt2"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">put_policy.return_url = create_posts_url</code></div><div class="line number26 index25 alt1"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">Qiniu::Auth.generate_uptoken(put_policy)</code></div><div class="line number27 index26 alt2"><code class="ruby spaces">&nbsp;</code><code class="ruby keyword">end</code></div></div></td></tr></tbody></table></div></div>
</div>
<p>ç¼–è¾‘ config/routes.rbï¼Œå°† create action å®šä¹‰ä¸ºä½¿ç”¨ get æ–¹æ³•äº¦å¯è®¿é—®:</p>
<div class="jb51code">
<div><div id="highlighter_703367" class="syntaxhighlighter  ruby"><div class="toolbar"><span><a href="#" class="toolbar_item command_help help">?</a></span></div><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="ruby plain">resources </code><code class="ruby color2">:posts</code> <code class="ruby keyword">do</code></div><div class="line number2 index1 alt1"><code class="ruby plain">collection </code><code class="ruby keyword">do</code></div><div class="line number3 index2 alt2"><code class="ruby plain">get </code><code class="ruby string">'create'</code><code class="ruby plain">, as: </code><code class="ruby color2">:create</code></div><div class="line number4 index3 alt1"><code class="ruby keyword">end</code></div><div class="line number5 index4 alt2"><code class="ruby keyword">end</code></div></div></td></tr></tbody></table></div></div>
</div>
<p>é‡æ–°å¯åŠ¨ rails serverï¼Œè®¿é—® http://localhost:3000/posts/newï¼Œç°åœ¨æˆ‘ä»¬å·²ç»å¯ä»¥åœ¨å‘è¡¨æ–° post çš„æ—¶å€™ä¸Šä¼ å›¾ç‰‡è‡³ä¸ƒç‰›äº‘å­˜å‚¨ã€‚&lt;/p&gt;
<p><strong>æç¤ºï¼š&lt;/strong&gt;&lt;/p&gt;
<p>æ–‡ä»¶å°†ä¼šä¸Šä¼ åˆ°åä¸º konata çš„å…¬å¼€ç©ºé—´ï¼ˆbucketï¼‰ã€‚&lt;br&gt;
æˆ‘ä»¬æ²¡æœ‰åœ¨ä»£ç ä¸­æŒ‡å®š keyï¼Œä¸ƒç‰›äº‘å­˜å‚¨é»˜è®¤ä¼šä½¿ç”¨æ ¹æ®æ–‡ä»¶å†…å®¹è®¡ç®—çš„ hash (etag) å€¼åšä¸º keyã€‚è¿™ç§åšæ³•å¯ä»¥éå¸¸ç®€å•åœ°é¿å…å†…å®¹ç›¸åŒçš„æ–‡ä»¶å­˜å‚¨å¤šä»½æµªè´¹ç©ºé—´ã€‚&lt;br&gt;
ç”±äºä¸Šä¼ è¡¨å•å°†ä¼šç›´æ¥æäº¤åˆ°ä¸ƒç‰›äº‘å­˜å‚¨æœåŠ¡å™¨ï¼Œæˆ‘ä»¬çš„åº”ç”¨ç¨‹åºåç«¯æ— æ³•è·å¾— title ç­‰ä¸šåŠ¡å¯¹è±¡å­—æ®µï¼Œæˆ‘ä»¬ä½¿ç”¨ä¸ƒç‰›äº‘å­˜å‚¨ API çš„ <a rel="nofollow" target="_blank" href="http://developer.qiniu.com/docs/v6/api/overview/up/response/vars.html#xvar">è‡ªå®šä¹‰å˜é‡&lt;/a&gt; å’Œ <a rel="nofollow" target="_blank" href="http://developer.qiniu.com/docs/v6/api/overview/up/response/response-body.html">è‡ªå®šä¹‰å“åº”å†…å®¹&lt;/a&gt; åŠŸèƒ½ï¼Œé€šè¿‡ä¸ƒç‰›äº‘å­˜å‚¨ä¸Šä¼  API ä¸­è½¬è·å¾—è¿™äº›å­—æ®µã€‚&lt;br&gt;
å±•ç¤ºç”¨æˆ·ä¸Šä¼ çš„å›¾ç‰‡&lt;/p&gt;
<p>ä¿®æ”¹ app/helpers/application_helper.rbï¼Œæ·»åŠ  qiniu_image_url æ–¹ä¾¿ç”Ÿæˆå›¾ç‰‡ URLã€‚ä¸ºäº†ä¿æŒç®€å•æˆ‘ä»¬ç›´æ¥ç¡¬ç¼–ç äº†ç©ºé—´çš„åŸŸåï¼š&lt;/p&gt;
<div class="jb51code">
<div><div id="highlighter_736409" class="syntaxhighlighter  ruby"><div class="toolbar"><span><a href="#" class="toolbar_item command_help help">?</a></span></div><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="ruby keyword">def</code> <code class="ruby plain">qiniu_image_url(post, format = </code><code class="ruby color2">:raw</code><code class="ruby plain">)</code></div><div class="line number2 index1 alt1"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">url = </code><code class="ruby string">"<a href="http://7xokus.com2.z0.glb.qiniucdn.com/">http://7xokus.com2.z0.glb.qiniucdn.com/</a>#{post.qiniu_hash}"</code></div><div class="line number3 index2 alt2">&nbsp;</div><div class="line number4 index3 alt1"><code class="ruby spaces">&nbsp;</code><code class="ruby keyword">case</code> <code class="ruby plain">format</code></div><div class="line number5 index4 alt2"><code class="ruby spaces">&nbsp;</code><code class="ruby keyword">when</code> <code class="ruby color2">:square</code></div><div class="line number6 index5 alt1"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">url &lt;&lt; </code><code class="ruby string">'?imageView2/1/w/300/h/300/q/90'</code></div><div class="line number7 index6 alt2"><code class="ruby spaces">&nbsp;</code><code class="ruby keyword">when</code> <code class="ruby color2">:preview</code></div><div class="line number8 index7 alt1"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">url &lt;&lt; </code><code class="ruby string">'?imageView2/2/w/1000/h/1000/q/90'</code></div><div class="line number9 index8 alt2"><code class="ruby spaces">&nbsp;</code><code class="ruby keyword">when</code> <code class="ruby color2">:raw</code></div><div class="line number10 index9 alt1"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">url &lt;&lt; </code><code class="ruby string">"?attname=#{post.filename}"</code></div><div class="line number11 index10 alt2"><code class="ruby spaces">&nbsp;</code><code class="ruby keyword">else</code></div><div class="line number12 index11 alt1"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">url</code></div><div class="line number13 index12 alt2"><code class="ruby spaces">&nbsp;</code><code class="ruby keyword">end</code></div><div class="line number14 index13 alt1"><code class="ruby spaces">&nbsp;</code><code class="ruby keyword">end</code></div></div></td></tr></tbody></table></div></div>
</div>
<p>ä¿®æ”¹ app/views/posts/index.html.erb å’Œ app/views/posts/show.html.erbï¼Œè°ƒç”¨åˆšæ‰åˆ›å»ºçš„ URL helper å±•ç¤ºå›¾ç‰‡ï¼š&lt;/p&gt;
<div class="jb51code">
<div><div id="highlighter_922931" class="syntaxhighlighter  ruby"><div class="toolbar"><span><a href="#" class="toolbar_item command_help help">?</a></span></div><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="ruby plain">&lt;tr&gt;</code></div><div class="line number2 index1 alt1"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">&lt;td&gt;&lt;%= post.title %&gt;&lt;/td&gt;</code></div><div class="line number3 index2 alt2"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">&lt;td&gt;&lt;%= link_to image_tag(qiniu_image_url(post, </code><code class="ruby color2">:square</code><code class="ruby plain">), size: </code><code class="ruby string">'300'</code><code class="ruby plain">), post %&gt;&lt;/td&gt;</code></div><div class="line number4 index3 alt1"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">&lt;td&gt;&lt;%= link_to </code><code class="ruby string">'Destroy'</code><code class="ruby plain">, post, method: </code><code class="ruby color2">:delete</code><code class="ruby plain">, data: { confirm: </code><code class="ruby string">'Are you sure?'</code> <code class="ruby plain">} %&gt;&lt;/td&gt;</code></div><div class="line number5 index4 alt2"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">&lt;/tr&gt;</code></div></div></td></tr></tbody></table></div></div>
</div>
<div class="jb51code">
<div><div id="highlighter_881342" class="syntaxhighlighter  ruby"><div class="toolbar"><span><a href="#" class="toolbar_item command_help help">?</a></span></div><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="ruby plain">&lt;p&gt;</code></div><div class="line number2 index1 alt1"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">&lt;%= link_to image_tag(qiniu_image_url(</code><code class="ruby variable bold">@post</code><code class="ruby plain">, </code><code class="ruby color2">:preview</code><code class="ruby plain">)), qiniu_image_url(</code><code class="ruby variable bold">@post</code><code class="ruby plain">), </code><code class="ruby keyword">class</code><code class="ruby plain">: </code><code class="ruby string">'image'</code> <code class="ruby plain">%&gt;</code></div><div class="line number3 index2 alt2"><code class="ruby plain">&lt;/p&gt;</code></div><div class="line number4 index3 alt1">&nbsp;</div><div class="line number5 index4 alt2"><code class="ruby plain">&lt;%= link_to </code><code class="ruby string">'Back'</code><code class="ruby plain">, posts_path %&gt;</code></div></div></td></tr></tbody></table></div></div>
</div>
<p>ä¿®æ”¹ config/routes.rbï¼Œå°†ç½‘ç«™æ ¹ç›®å½•è®¾ç½®ä¸º posts åˆ—è¡¨é¡µé¢ï¼š&lt;/p&gt;
<p><br />
root 'posts#index'<br />
è®¿é—® http://localhost:3000ï¼Œç°åœ¨æˆ‘ä»¬å¯ä»¥çœ‹åˆ°åˆšæ‰ä¸Šä¼ çš„å›¾ç‰‡ã€‚&lt;/p&gt;
<p><strong>æç¤ºï¼š&lt;/strong&gt;&lt;/p&gt;
<p>æ¯ä¸ªç©ºé—´ï¼ˆbucketï¼‰å†…çš„èµ„æºéƒ½å¯ä»¥é€šè¿‡è¯¥ç©ºé—´çš„é»˜è®¤æˆ–è‡ªå®šä¹‰åŸŸåï¼ŒåŠ ä¸Šæ–‡ä»¶ key æ„é€ çš„ HTTP URL è¿›è¡Œè®¿é—®ã€‚&lt;br&gt;
å¯ä»¥åœ¨ URL åå¢åŠ ç‰¹å®šæŸ¥è¯¢å‚æ•°ï¼Œè°ƒç”¨ä¸ƒç‰›äº‘å­˜å‚¨å¼ºå¤§çš„ <a rel="nofollow" target="_blank" href="http://developer.qiniu.com/docs/v6/api/overview/fop/">æ•°æ®å¤„ç†ï¼ˆFopï¼‰&lt;/a&gt; APIï¼Œå®æ—¶ç”Ÿæˆè‡ªå®šä¹‰æ ¼å¼çš„ç¼©ç•¥å›¾ã€‚&lt;br&gt;
å¯ä»¥é€šè¿‡æŸ¥è¯¢å‚æ•° attname æŒ‡å®š URL ä¸‹è½½æ—¶ä½¿ç”¨çš„æ–‡ä»¶åã€‚&lt;br&gt;
<strong>ç®€å•çš„ UI ç¾åŒ–</strong>&lt;/p&gt;
<p>ä¿®æ”¹ app/views/posts/index.html.erbï¼Œå°†åŸæœ‰çš„ table å¸ƒå±€æ”¹ä¸º flexbox å¸ƒå±€ï¼š&lt;/p&gt;
<div class="jb51code">
<div><div id="highlighter_614870" class="syntaxhighlighter  ruby"><div class="toolbar"><span><a href="#" class="toolbar_item command_help help">?</a></span></div><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="ruby plain">&lt;div </code><code class="ruby keyword">class</code><code class="ruby plain">=</code><code class="ruby string">"posts"</code><code class="ruby plain">&gt;</code></div><div class="line number2 index1 alt1"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">&lt;% </code><code class="ruby variable bold">@posts</code><code class="ruby plain">.</code><code class="ruby keyword">each</code> <code class="ruby keyword">do</code> <code class="ruby plain">|post| %&gt;</code></div><div class="line number3 index2 alt2"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">&lt;p&gt;</code></div><div class="line number4 index3 alt1"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">&lt;%= link_to image_tag(qiniu_image_url(post, </code><code class="ruby color2">:square</code><code class="ruby plain">), size: </code><code class="ruby string">'300'</code><code class="ruby plain">), post, </code><code class="ruby keyword">class</code><code class="ruby plain">: </code><code class="ruby string">'image'</code> <code class="ruby plain">%&gt;</code></div><div class="line number5 index4 alt2"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">&lt;br&gt;</code></div><div class="line number6 index5 alt1"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">&lt;%= post.title %&gt;</code></div><div class="line number7 index6 alt2"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">&lt;br&gt;</code></div><div class="line number8 index7 alt1"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">&lt;%= link_to </code><code class="ruby string">'Destroy'</code><code class="ruby plain">, post, method: </code><code class="ruby color2">:delete</code><code class="ruby plain">, data: { confirm: </code><code class="ruby string">'Are you sure?'</code> <code class="ruby plain">} %&gt;</code></div><div class="line number9 index8 alt2"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">&lt;/p&gt;</code></div><div class="line number10 index9 alt1"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">&lt;% </code><code class="ruby keyword">end</code> <code class="ruby plain">%&gt;</code></div><div class="line number11 index10 alt2"><code class="ruby plain">&lt;/div&gt;</code></div></div></td></tr></tbody></table></div></div>
</div>
<p>ä¿®æ”¹ app/assets/stylesheets/application.cssï¼ŒåŠ å…¥å¯¹åº”çš„ CSSï¼š&lt;/p&gt;
<div class="jb51code">
<div><div id="highlighter_953932" class="syntaxhighlighter  ruby"><div class="toolbar"><span><a href="#" class="toolbar_item command_help help">?</a></span></div><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="ruby plain">body {</code></div><div class="line number2 index1 alt1"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">padding: 20px;</code></div><div class="line number3 index2 alt2"><code class="ruby plain">}</code></div><div class="line number4 index3 alt1">&nbsp;</div><div class="line number5 index4 alt2"><code class="ruby plain">a.image</code><code class="ruby color2">:hover</code> <code class="ruby plain">{</code></div><div class="line number6 index5 alt1"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">background-color: transparent;</code></div><div class="line number7 index6 alt2"><code class="ruby plain">}</code></div><div class="line number8 index7 alt1">&nbsp;</div><div class="line number9 index8 alt2"><code class="ruby plain">div.posts {</code></div><div class="line number10 index9 alt1"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">display: flex;</code></div><div class="line number11 index10 alt2"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">flex-flow: row wrap;</code></div><div class="line number12 index11 alt1"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">justify-content: space-between;</code></div><div class="line number13 index12 alt2"><code class="ruby plain">}</code></div></div></td></tr></tbody></table></div></div>
</div>
<p>è®¿é—® http://localhost:3000ï¼Œå›¾ç‰‡åˆ—è¡¨çœ‹èµ·æ¥åƒä¸€ä¸ªæ­£å¸¸çš„ç›¸å†Œäº†ã€‚&lt;/p&gt;
<p><strong>æ·»åŠ ç”¨æˆ·è´¦æˆ·åŠŸèƒ½</strong></p>
<p>æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºè¿˜æœ‰ä¸¤ä¸ªæ˜æ˜¾çš„é—®é¢˜ï¼šæ²¡æœ‰è®°å½•å›¾ç‰‡æ˜¯ç”±è°åˆ†äº«çš„ï¼›ä»»ä½•äººéƒ½å¯ä»¥åˆ é™¤ postã€‚è¿™å¯¹äºä¸€ä¸ªç¤¾äº¤åº”ç”¨æ¥è¯´æ˜¾ç„¶æ˜¯ä¸èƒ½æ¥å—çš„é—®é¢˜ã€‚è¿™å¯¹äºä¸€ä¸ªç¤¾äº¤åº”ç”¨æ¥è¯´æ˜¾ç„¶æ˜¯ä¸å¯æ¥å—çš„ï¼Œæ‰€ä»¥æ¥ä¸‹æ¥æˆ‘ä»¬å°†ä½¿ç”¨ Rails ç¤¾åŒºæµè¡Œçš„ Devise ç»„ä»¶ç›´æ¥è·å¾—ç”¨æˆ·æ³¨å†Œã€ç™»å½•ã€éªŒè¯å­ç³»ç»Ÿï¼Œå®ç°å›¾ç‰‡å‘è¡¨è€…ä¿¡æ¯è®°å½•ç­‰åŠŸèƒ½ã€‚&lt;/p&gt;
<p>ä¿®æ”¹ Gemfileï¼ŒåŠ å…¥å¯¹ Devise çš„ä¾èµ–ï¼š</p>
<p></p><div class="codetitle"><span><a style="CURSOR: pointer" data="47710" class="copybut" id="copybut47710" onclick="doCopy('code47710')"><u>å¤åˆ¶ä»£ç </u></a></span> ä»£ç å¦‚ä¸‹:</div><div class="codebody" id="code47710"><br />
gem 'devise'<br />
</div><p></p>
<p>æ‰§è¡Œä»¥ä¸‹å‘½ä»¤å®‰è£… Deviseï¼Œç”Ÿæˆ User modelï¼Œä»¥åŠæˆ‘ä»¬æ‰€éœ€çš„ data migrationï¼š&lt;/p&gt;
<p></p><div class="codetitle"><span><a style="CURSOR: pointer" data="67600" class="copybut" id="copybut67600" onclick="doCopy('code67600')"><u>å¤åˆ¶ä»£ç </u></a></span> ä»£ç å¦‚ä¸‹:</div><div class="codebody" id="code67600"><br />
bundle<br />
rails generate devise:install<br />
rails generate devise user<br />
rails generate migration add_author_to_posts creator:belongs_to<br />
rake db:migrate<br />
</div><p></p>
<p>ä¿®æ”¹ app/controllers/posts_controller.rbï¼Œå¯¹æŸ¥çœ‹ä»¥å¤–çš„æ“ä½œè¦æ±‚ç™»å½•ï¼Œå¹¶åœ¨å‘è¡¨ post æ—¶è®°å½•å‘è¡¨è€…èº«ä»½ï¼š</p>
<div class="jb51code">
<div><div id="highlighter_134512" class="syntaxhighlighter  ruby"><div class="toolbar"><span><a href="#" class="toolbar_item command_help help">?</a></span></div><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="ruby plain">before_action </code><code class="ruby color2">:authenticate_user</code><code class="ruby plain">!, except: [</code><code class="ruby color2">:index</code><code class="ruby plain">, </code><code class="ruby color2">:show</code><code class="ruby plain">]</code></div><div class="line number2 index1 alt1">&nbsp;</div><div class="line number3 index2 alt2"><code class="ruby keyword">def</code> <code class="ruby plain">create</code></div><div class="line number4 index3 alt1"><code class="ruby comments"># ...</code></div><div class="line number5 index4 alt2"><code class="ruby variable bold">@post</code> <code class="ruby plain">= Post.</code><code class="ruby keyword">new</code><code class="ruby plain">(</code></div><div class="line number6 index5 alt1"><code class="ruby plain">title: upload_ret[</code><code class="ruby string">'title'</code><code class="ruby plain">],</code></div><div class="line number7 index6 alt2"><code class="ruby plain">filename: upload_ret[</code><code class="ruby string">'fname'</code><code class="ruby plain">],</code></div><div class="line number8 index7 alt1"><code class="ruby plain">qiniu_hash: upload_ret[</code><code class="ruby string">'hash'</code><code class="ruby plain">],</code></div><div class="line number9 index8 alt2"><code class="ruby plain">creator: current_user</code></div><div class="line number10 index9 alt1"><code class="ruby plain">)</code></div><div class="line number11 index10 alt2"><code class="ruby comments"># ...</code></div><div class="line number12 index11 alt1"><code class="ruby keyword">end</code></div></div></td></tr></tbody></table></div></div>
</div>
<p>ä¿®æ”¹ app/models/post.rbï¼Œæ·»åŠ ä¸ User model çš„ä»å±å…³è”ï¼š</p>
<p></p><div class="codetitle"><span><a style="CURSOR: pointer" data="34488" class="copybut" id="copybut34488" onclick="doCopy('code34488')"><u>å¤åˆ¶ä»£ç </u></a></span> ä»£ç å¦‚ä¸‹:</div><div class="codebody" id="code34488"><br />
belongs_to :creator, class_name: 'User'<br />
</div><br />
ä¿®æ”¹ app/views/layouts/application.html.erbï¼Œæ·»åŠ ç™»å½•çŠ¶æ€ä¿¡æ¯å’Œæ³¨é”€é“¾æ¥ï¼š&lt;p&gt;</p>
<div class="jb51code">
<div><div id="highlighter_578041" class="syntaxhighlighter  ruby"><div class="toolbar"><span><a href="#" class="toolbar_item command_help help">?</a></span></div><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="ruby plain">&lt;header&gt;</code></div><div class="line number2 index1 alt1"><code class="ruby plain">&lt;% </code><code class="ruby keyword">if</code> <code class="ruby plain">user_signed_in? %&gt;</code></div><div class="line number3 index2 alt2"><code class="ruby plain">&lt;p&gt;</code></div><div class="line number4 index3 alt1"><code class="ruby plain">Hello &lt;%= current_user.email %&gt;</code></div><div class="line number5 index4 alt2"><code class="ruby plain">&lt;%= link_to </code><code class="ruby string">'Logout'</code><code class="ruby plain">, destroy_user_session_path, method: </code><code class="ruby color2">:delete</code> <code class="ruby plain">%&gt;</code></div><div class="line number6 index5 alt1"><code class="ruby plain">&lt;/p&gt;</code></div><div class="line number7 index6 alt2"><code class="ruby plain">&lt;% </code><code class="ruby keyword">end</code> <code class="ruby plain">%&gt;</code></div><div class="line number8 index7 alt1"><code class="ruby plain">&lt;/header&gt;</code></div></div></td></tr></tbody></table></div></div>
</div>
<p>ä¿®æ”¹ app/views/posts/index.html.erbï¼Œé™åˆ¶ä»… post å‘è¡¨è€…å¯ä»¥åˆ é™¤è¯¥ postï¼š&lt;/p&gt;
<div class="jb51code">
<div><div id="highlighter_177805" class="syntaxhighlighter  ruby"><div class="toolbar"><span><a href="#" class="toolbar_item command_help help">?</a></span></div><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="ruby plain">&lt;% </code><code class="ruby keyword">if</code> <code class="ruby plain">user_signed_in? </code><code class="ruby keyword">and</code> <code class="ruby plain">post.creator == current_user %&gt;</code></div><div class="line number2 index1 alt1"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">&lt;br&gt;</code></div><div class="line number3 index2 alt2"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">&lt;%= link_to </code><code class="ruby string">'Destroy'</code><code class="ruby plain">, post, method: </code><code class="ruby color2">:delete</code><code class="ruby plain">, data: { confirm: </code><code class="ruby string">'Are you sure?'</code> <code class="ruby plain">} %&gt;</code></div><div class="line number4 index3 alt1"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">&lt;% </code><code class="ruby keyword">end</code> <code class="ruby plain">%&gt;</code></div></div></td></tr></tbody></table></div></div>
</div>
<p>é‡å¯ rails server åï¼Œè®¿é—® <a rel="nofollow" href="http://localhost:3000">http://localhost:3000</a>ï¼Œç°åœ¨ç”¨æˆ·éœ€è¦æ³¨å†Œç™»å½•æ‰èƒ½å‘è¡¨å›¾ç‰‡äº†ã€‚&lt;/p&gt;
<p>å®ç°ç‚¹èµåŠŸèƒ½</p>
<p>æœ€åï¼Œåšä¸ºä¸€ä¸ªç¤¾äº¤åº”ç”¨ï¼Œæ²¡æœ‰ç‚¹èµåŠŸèƒ½æ€ä¹ˆèƒ½è®©ç‚¹èµç‹‚é­”ä»¬æ»¡è¶³å‘¢ï¼Ÿï¼æˆ‘ä»¬å°†æ·»åŠ ä¸€ä¸ª like scaffold ç”¨æ¥å¤„ç†ç‚¹èµå’Œå­˜å‚¨ç‚¹èµä¿¡æ¯ã€‚&lt;/p&gt;
<p>æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ç”Ÿæˆ scaffoldï¼ŒLike model å°†åšä¸ºä¸€ä¸ª join model åŒæ—¶ä»å±äº Post å’Œ Userï¼š&lt;/p&gt;
<p></p><div class="codetitle"><span><a style="CURSOR: pointer" data="33824" class="copybut" id="copybut33824" onclick="doCopy('code33824')"><u>å¤åˆ¶ä»£ç </u></a></span> ä»£ç å¦‚ä¸‹:</div><div class="codebody" id="code33824"><br />
rails generate scaffold like post:belongs_to user:belongs_to<br />
rake db:migrate<br />
</div><p></p>
<p>ä¿®æ”¹ app/models/post.rbï¼Œå»ºç«‹ Post ä¸ Like model çš„â€œæ‹¥æœ‰ï¼åµŒå¥—â€å…³ç³»ï¼š</p>
<p></p><div class="codetitle"><span><a style="CURSOR: pointer" data="9257" class="copybut" id="copybut9257" onclick="doCopy('code9257')"><u>å¤åˆ¶ä»£ç </u></a></span> ä»£ç å¦‚ä¸‹:</div><div class="codebody" id="code9257"><br />
has_many :likes<br />
</div><br />
ä¿®æ”¹ app/models/like.rbï¼Œé™åˆ¶ä¸€ä¸ªç‚¹èµç‹‚é­”å¯¹ä¸€ä¸ª post åªèƒ½ç‚¹ä¸€æ¬¡èµï¼š&lt;p&gt;</p>
<p></p><div class="codetitle"><span><a style="CURSOR: pointer" data="82959" class="copybut" id="copybut82959" onclick="doCopy('code82959')"><u>å¤åˆ¶ä»£ç </u></a></span> ä»£ç å¦‚ä¸‹:</div><div class="codebody" id="code82959"><br />
validates_uniqueness_of :user, scope: :post<br />
</div><br />
ä¿®æ”¹ config/routes.rbï¼Œå°† likes è®¾ç½®ä¸º posts çš„åµŒå¥—èµ„æºï¼š<p></p>
<p></p><div class="codetitle"><span><a style="CURSOR: pointer" data="35297" class="copybut" id="copybut35297" onclick="doCopy('code35297')"><u>å¤åˆ¶ä»£ç </u></a></span> ä»£ç å¦‚ä¸‹:</div><div class="codebody" id="code35297"><br />
resources :posts do<br />
# ...<br />
resources :likes<br />
end<br />
</div><br />
ä¿®æ”¹ app/views/posts/index.html.erbï¼Œæ·»åŠ ç‚¹èµä¿¡æ¯æ˜¾ç¤ºä»¥åŠ AJAX ç‚¹èµé“¾æ¥ï¼š&lt;p&gt;</p>
<div class="jb51code">
<div><div id="highlighter_71392" class="syntaxhighlighter  ruby"><div class="toolbar"><span><a href="#" class="toolbar_item command_help help">?</a></span></div><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="ruby plain">&lt;%= post.title %&gt;</code></div><div class="line number2 index1 alt1"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">&lt;br&gt;</code></div><div class="line number3 index2 alt2"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">&lt;%= content_tag(</code><code class="ruby color2">:span</code><code class="ruby plain">, </code><code class="ruby string">"#{post.likes.count} likes"</code><code class="ruby plain">, id: </code><code class="ruby string">"post_#{post.id}_likes"</code><code class="ruby plain">) %&gt;</code></div><div class="line number4 index3 alt1">&nbsp;</div><div class="line number5 index4 alt2"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">&lt;% </code><code class="ruby keyword">if</code> <code class="ruby plain">user_signed_in? %&gt;</code></div><div class="line number6 index5 alt1"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">&lt;br&gt;</code></div><div class="line number7 index6 alt2"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">&lt;%= link_to </code><code class="ruby string">'Like'</code><code class="ruby plain">, post_likes_path(post), method: </code><code class="ruby color2">:post</code><code class="ruby plain">, remote: </code><code class="ruby keyword">true</code> <code class="ruby plain">%&gt;</code></div><div class="line number8 index7 alt1">&nbsp;</div><div class="line number9 index8 alt2"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">&lt;% </code><code class="ruby keyword">if</code> <code class="ruby plain">post.creator == current_user %&gt;</code></div><div class="line number10 index9 alt1"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">&lt;%= link_to </code><code class="ruby string">'Destroy'</code><code class="ruby plain">, post, method: </code><code class="ruby color2">:delete</code><code class="ruby plain">, data: { confirm: </code><code class="ruby string">'Are you sure?'</code> <code class="ruby plain">} %&gt;</code></div><div class="line number11 index10 alt2"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">&lt;% </code><code class="ruby keyword">end</code> <code class="ruby plain">%&gt;</code></div><div class="line number12 index11 alt1"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">&lt;% </code><code class="ruby keyword">end</code> <code class="ruby plain">%&gt;</code></div></div></td></tr></tbody></table></div></div>
</div>
<p>ä¿®æ”¹ app/controllers/likes_controller.rbï¼ŒçœŸæ­£å°† likes èµ„æºå®ç°ä¸º posts çš„åµŒå¥—èµ„æºï¼Œå¹¶åœ¨ç‚¹èµæ—¶è®°å½•ç‚¹èµç‹‚é­”çš„èº«ä»½ï¼š&lt;/p&gt;
<div class="jb51code">
<div><div id="highlighter_500953" class="syntaxhighlighter  ruby"><div class="toolbar"><span><a href="#" class="toolbar_item command_help help">?</a></span></div><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div><div class="line number17 index16 alt2">17</div><div class="line number18 index17 alt1">18</div><div class="line number19 index18 alt2">19</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="ruby plain">before_action </code><code class="ruby color2">:set_post</code></div><div class="line number2 index1 alt1">&nbsp;</div><div class="line number3 index2 alt2"><code class="ruby spaces">&nbsp;</code><code class="ruby keyword">def</code> <code class="ruby plain">create</code></div><div class="line number4 index3 alt1"><code class="ruby spaces">&nbsp;</code><code class="ruby variable bold">@like</code> <code class="ruby plain">= </code><code class="ruby variable bold">@post</code><code class="ruby plain">.likes.</code><code class="ruby keyword">new</code><code class="ruby plain">(user: current_user)</code></div><div class="line number5 index4 alt2">&nbsp;</div><div class="line number6 index5 alt1"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">respond_to </code><code class="ruby keyword">do</code> <code class="ruby plain">|format|</code></div><div class="line number7 index6 alt2"><code class="ruby spaces">&nbsp;</code><code class="ruby keyword">if</code> <code class="ruby variable bold">@like</code><code class="ruby plain">.save</code></div><div class="line number8 index7 alt1"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">format.js { }</code></div><div class="line number9 index8 alt2"><code class="ruby spaces">&nbsp;</code><code class="ruby keyword">else</code></div><div class="line number10 index9 alt1"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">format.js { }</code></div><div class="line number11 index10 alt2"><code class="ruby spaces">&nbsp;</code><code class="ruby keyword">end</code></div><div class="line number12 index11 alt1"><code class="ruby spaces">&nbsp;</code><code class="ruby keyword">end</code></div><div class="line number13 index12 alt2"><code class="ruby spaces">&nbsp;</code><code class="ruby keyword">end</code></div><div class="line number14 index13 alt1">&nbsp;</div><div class="line number15 index14 alt2"><code class="ruby spaces">&nbsp;</code><code class="ruby plain">private</code></div><div class="line number16 index15 alt1">&nbsp;</div><div class="line number17 index16 alt2"><code class="ruby spaces">&nbsp;</code><code class="ruby keyword">def</code> <code class="ruby plain">set_post</code></div><div class="line number18 index17 alt1"><code class="ruby spaces">&nbsp;</code><code class="ruby variable bold">@post</code> <code class="ruby plain">= Post.find(params[</code><code class="ruby color2">:post_id</code><code class="ruby plain">])</code></div><div class="line number19 index18 alt2"><code class="ruby spaces">&nbsp;</code><code class="ruby keyword">end</code></div></div></td></tr></tbody></table></div></div>
</div>
<p>åˆ›å»º app/views/likes/create.js.erbï¼Œä½¿ç”¨ Server-generated JavaScript æ›´æ–°ç‚¹èµä¿¡æ¯ï¼š&lt;/p&gt;
<p></p><div class="codetitle"><span><a style="CURSOR: pointer" data="78282" class="copybut" id="copybut78282" onclick="doCopy('code78282')"><u>å¤åˆ¶ä»£ç </u></a></span> ä»£ç å¦‚ä¸‹:</div><div class="codebody" id="code78282"><br />
$("#&lt;%= "post_#{@post.id}_likes" %&gt;").text("&lt;%= "#{@post.likes.count} likes" %&gt;")<br />
</div><br />
é‡å¯ rails server åï¼Œè®¿é—® http://localhost:3000ï¼Œè®©æˆ‘ä»¬æ„‰å¿«åœ°ç‚¹èµå§ï½&lt;p&gt;</p>
<p><strong>å°ç»“</strong></p>
<p>è™½ç„¶è¿™åªæ˜¯ä¸€ä¸ªç®€å•çš„åŸå‹ï¼Œä½†æ˜¯å› ä¸ºä½¿ç”¨äº†ä¸ƒç‰›äº‘å­˜å‚¨ä½œä¸ºå›¾ç‰‡å­˜å‚¨åç«¯ï¼Œæˆ‘ä»¬çš„ç¤¾äº¤åº”ç”¨äº§å“åœ¨ä¸€å¼€å§‹çš„åŸå‹é˜¶æ®µå°±æ‹¥æœ‰äº†èƒ½ä¸ºå¤§è§„æ¨¡ç”¨æˆ·æä¾›é«˜é€Ÿã€å¯é æœåŠ¡çš„æ½œèƒ½ã€‚&lt;/p&gt;
<p>ç®€å•å›é¡¾ä¸€ä¸‹æˆ‘ä»¬åˆšæ‰å­¦ä¹ åˆ°çš„å†…å®¹å§ã€‚ä½¿ç”¨ Rails çš„ä»£ç ç”ŸæˆåŠŸèƒ½ï¼Œ åŸºäº CRUD ç»“æ„çš„ scaffold å®ç°ä¸šåŠ¡å¯¹è±¡ç»´æŠ¤ï¼Œä»¥åŠä¸šåŠ¡æ“ä½œéå¸¸é«˜æ•ˆï¼›ä½¿ç”¨ä¸ƒç‰›äº‘å­˜å‚¨åˆ™å¯ä»¥è½»æ¾å¤„ç†ä¸šåŠ¡ç³»ç»Ÿä¸­çš„æ–‡ä»¶å­˜å‚¨ï¼Œè·å¾—å›¾ç‰‡è§†é¢‘ç­‰å¤šåª’ä½“æ–‡ä»¶çš„äº‘ç«¯å¤„ç†èƒ½åŠ›ï¼Œå‡å°‘ï¼Œç”šè‡³é¿å…äº†éƒ¨åˆ†ç ”å‘å’Œè¿ç»´å·¥ä½œã€‚å¸Œæœ›è¿™ä¸ªè§†é¢‘å¯ä»¥å¸®åŠ©å¤§å®¶è®¤è¯†è¿™ä¸¤ä¸ªä¼˜ç§€çš„å¼€å‘å·¥å…·ï¼Œç›´è§‚æ„Ÿå—åˆ°å®ƒä»¬çš„é«˜æ•ˆå¼ºå¤§å’Œç®€å•æ˜“ç”¨ã€‚&lt;/p&gt;
<p><strong>å‚è€ƒèµ„æ–™&lt;/strong&gt;&lt;/p&gt;
<p><a rel="nofollow" target="_blank" href="http://guides.rubyonrails.org/">Ruby on Rails Guides</a><br />
<a rel="nofollow" target="_blank" href="http://developer.qiniu.com/">ä¸ƒç‰›å¼€å‘è€…ä¸­å¿ƒ&lt;/a&gt;&lt;/p&gt;
<p><strong>ç¤ºä¾‹ä»£ç </strong></p>
<p><a rel="nofollow" target="_blank" href="https://github.com/rainux/konata-sample">https://github.com/rainux/konata-sample</a></p>
<p>æ¯”èµ·ç›´æ¥è¯•ç”¨ç¤ºä¾‹ä»£ç ï¼Œä½ åº”è¯¥æŒ‰ç…§æ•™ç¨‹è‡ªå·±ç¼–å†™è¿™äº›ä»£ç ï¼Œäº²è‡ªç¼–å†™ä»£ç æœ‰åŠ©äºåŠ æ·±ç†è§£å’Œè®°å¿†ã€‚&lt;/p&gt;

&lt;/div&gt;
</p></a></p></strong></p></p></p></p></p></p></p></p></p></p></a></p></strong></p></p></p></p></p></a></a></p></strong></p></p></p></p></p></p></strong></p></p></p></p></p></a></p></p></p></div>
:ET