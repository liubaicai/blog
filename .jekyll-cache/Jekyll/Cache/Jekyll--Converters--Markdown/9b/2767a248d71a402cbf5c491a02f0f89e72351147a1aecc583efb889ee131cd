I"ƒ{<h4>æœåŠ¡å™¨ç›‘æ§çš„æ›´å¥½è§£å†³æ–¹æ¡ˆ</h4>
<p>Godæ˜¯ä¸€ä¸ªç”¨Rubyå†™æˆçš„ï¼Œå®¹æ˜“é…ç½®ï¼Œå®¹æ˜“æ‰©å±•çš„æœåŠ¡å™¨ç›‘æ§æ¡†æ¶ã€‚</p>

<p>ä¿æŒä½ çš„æœåŠ¡å™¨çš„ç¨‹åºå’Œä»»åŠ¡è¿è¡Œåº”è¯¥æ˜¯ä½ éƒ¨ç½²è¿‡ç¨‹ä¸­ç®€å•çš„ä¸€éƒ¨åˆ†ã€‚Godçš„ç›®æ ‡åšæœ€ç®€å•ã€åŠŸèƒ½æœ€å¼ºçš„ç›‘æ§åº”ç”¨ç¨‹åºã€‚</p>

<p>Tom Preston-Werner
tom@mojombo.com</p>

<p>Google Group:<a href="http://groups.google.com/group/god-rb" target="_blank">http://groups.google.com/group/god-rb</a></p>
<h4>ç³»ç»Ÿç‰¹æ€§&lt;/h4&gt;
<ul>
	<li>é…ç½®æ–‡ä»¶ä¸ºRubyç¨‹åº</li>
	<li>å¯ä»¥å®¹æ˜“åœ°ç”¨Rubyè‡ªå®šä¹‰æ¡ä»¶&lt;/li&gt;
	<li>æ”¯æŒåŸºäºæ¡ä»¶çš„pollå’Œevent</li>
	<li>ä¸åŒçš„pollæ¡ä»¶å¯ä»¥æœ‰ä¸åŒçš„é—´éš”</li>
	<li>é›†æˆäº‹ä»¶é€šçŸ¥ç³»ç»Ÿï¼ˆå¯æ‰©å±•ï¼‰&lt;/li&gt;
	<li>å®¹æ˜“åœ°æ§åˆ¶éå®ˆæŠ¤è„šæœ¬</li>
&lt;/ul&gt;
<h4>å®‰è£…</h4>
æœ€å¥½çš„æ–¹æ³•æ˜¯é€šè¿‡rubygemså®‰è£…ï¼š
<pre class="highlight plaintext">     $[sudo] gem install god
</pre>
<h4>ç³»ç»Ÿéœ€æ±‚&lt;/h4&gt;
Godç›®å‰ä»…ä»…åœ¨Linuxï¼ˆKernel 2.6.15+ï¼‰,BSD, å’ŒDarwinç³»ç»Ÿä¸Šè¿è¡Œã€‚æš‚æ—¶æ²¡æœ‰æ”¯æŒWindowsç³»ç»Ÿçš„è®¡åˆ’ã€‚åœ¨Linuxç³»ç»Ÿä¸ŠåŸºäºæ¡ä»¶çš„äº‹ä»¶ç›‘æ§éœ€è¦åŠ è½½cnï¼ˆconnectorï¼‰æ ¸å¿ƒæ¨¡å—æˆ–è€…ç¼–è¯‘è¿›æ ¸å¿ƒï¼Œgodéœ€è¦ä»¥*root*æƒé™è¿è¡Œã€‚

ä»¥ä¸‹ç³»ç»Ÿå·²ç»æµ‹è¯•è¿‡ã€‚æ¬¢è¿å¸®å¿™æµ‹è¯•å…¶ä»–ç³»ç»Ÿï¼
* Darwin 10.4.10
* RedHat Fedora 6-15
* Ubuntu Dapperï¼ˆno eventsï¼‰
* Ubuntu Feisty
* CentOS 4.5ï¼ˆno eventsï¼‰, 5, 6
<h4>å¿«é€Ÿå¼€å§‹&lt;/h4&gt;
å¤‡æ³¨ï¼š è¿™ä¸ªå¿«é€Ÿå‘å¯¼éœ€è¦0.12.0ä»¥åçš„ç‰ˆæœ¬ã€‚ä½ å¯ä»¥æ£€æŸ¥ä½ çš„ç‰ˆæœ¬ï¼š
<pre class="highlight plaintext">  $ god --version
</pre>
æœ€ç®€å•çš„ç†è§£godæ€ä¹ˆè¿è¡Œçš„æ–¹æ³•æ˜¯æµ‹è¯•ä¸€ä¸ªç®€å•çš„ä¾‹å­ã€‚ä¸ºäº†è®©ä½ å¿«é€Ÿä¸Šæ‰‹ï¼Œæˆ‘å°†ç»™ä½ å±•ç¤ºæ€ä¹ˆä¿æŒä¸€ä¸ªå¾ˆå°çš„æœåŠ¡è¿è¡Œã€‚

æ–°å»ºä¸€ä¸ªç›®å½•ï¼Œç„¶åå†™ä¸€ä¸ªç®€å•çš„æœåŠ¡å™¨è„šæœ¬ã€‚è®©æˆ‘ä»¬ç»™å®ƒå‘½åä¸ºsimple.rb:
<pre class="lang:ruby decode:true">loop do
  puts 'Hello'
  sleep 1
end</pre>
ç°åœ¨æˆ‘ä»¬å°†å†™ä¸€ä¸ªgodé…ç½®æ–‡ä»¶ï¼Œå‘Šè¯‰godå…³äºæˆ‘ä»¬çš„è¿›ç¨‹ã€‚æŠŠå®ƒå’Œsimple.rbæ”¾åœ¨åŒä¸€ä¸ªæ–‡ä»¶å¤¹ï¼Œå‘½åä¸ºsimple.god:
<pre class="lang:ruby decode:true">God.watch do |w|
  w.name = "simple"
  w.start = "ruby /full/path/to/simple.rb"
  w.keepalive
end</pre>
è¿™æ˜¯æœ€ç®€å•çš„godé…ç½®æ–‡ä»¶ã€‚æˆ‘ä»¬ä»¥å®£å¸ƒä¸€ä¸ªGod.watchå—å¼€å§‹ã€‚ä¸€ä¸ªwatchåœ¨godé‡Œä»£è¡¨ä¸€ä¸ªæˆ‘ä»¬æƒ³è¦watchå’Œæ§åˆ¶çš„è¿›ç¨‹ã€‚æ¯ä¸ªwatchå¿…é¡»æœ‰ä¸€ä¸ªå”¯ä¸€çš„åå­—å’Œä¸€ä¸ªå‘Šè¯‰godæ€ä¹ˆå¯åŠ¨è¿›ç¨‹çš„å‘½ä»¤ã€‚*keepalive*çš„å£°æ˜å‘Šè¯‰godä¿æŒè¿™ä¸ªè¿›ç¨‹aliveã€‚å‡å¦‚godå¯åŠ¨æ—¶è¿™ä¸ªè¿›ç¨‹æ²¡æœ‰è¿è¡Œï¼Œgodå°†ä¼šå¯åŠ¨å®ƒã€‚å‡å¦‚è¿›ç¨‹ä¸å“åº”ï¼Œgodå°±ä¼šé‡æ–°å¯åŠ¨å®ƒã€‚

åœ¨è¿™ä¸ªä¾‹å­é‡Œï¼Œsimpleè¿›ç¨‹åœ¨å‰ç«¯è¿è¡Œï¼Œæ‰€ä»¥godä¼šç…§çœ‹è¯¥è¿›ç¨‹ï¼Œä¿æŒè·Ÿè¸ªè¿™ä¸ªè¿›ç¨‹çš„PIDã€‚å¦‚æœå¯èƒ½ï¼Œæœ€å¥½è¦godä¸ºæˆ‘ä»¬å¯åŠ¨è¿›ç¨‹ï¼Œè¿™æ ·æˆ‘ä»¬å°±ä¸å¿…æ‹…å¿ƒæŒ‡å®šå’Œä¿æŒè·Ÿè¸ªPIDçš„æ–‡ä»¶ã€‚åé¢æˆ‘ä»¬å°†çœ‹è§ä¸èƒ½åœ¨å‰æ™¯è¿è¡Œæˆ–è€…éœ€è¦æŒ‡å®šè¿›ç¨‹PIDçš„æƒ…å†µä¸‹æ€æ ·ç®¡ç†ã€‚

ä¸ºäº†è¿è¡Œgodï¼Œæˆ‘ä»¬ä½¿ç”¨å‚æ•°-cç»™å®ƒæä¾›ä¸€ä¸ªå‚æ•°ã€‚é€šè¿‡å‚æ•°-Då°±å¯ä»¥è®©godåœ¨å‰ç«¯è¿è¡Œï¼Œèƒ½è®©æˆ‘ä»¬çœ‹è§å‘ç”Ÿäº†ä»€ä¹ˆã€‚
<pre class="highlight plaintext"> $ god -c path/to/simple.god -D
</pre>
godå¯ä»¥é€šè¿‡ä¸¤ç§æ–¹å¼æ¥ç›‘æ§ä½ çš„è¿›ç¨‹ã€‚ç¬¬ä¸€ä¸ªå’Œæœ€å¥½çš„ä¸€ä¸ªæ˜¯æ–¹æ³•æ˜¯ç”¨eventã€‚ä¸æ˜¯æ¯ä¸ªç³»ç»Ÿéƒ½æ”¯æŒï¼Œä½†æ˜¯å¦‚æœç³»ç»Ÿæ”¯æŒçš„è¯ä¼šè‡ªåŠ¨ä½¿ç”¨eventã€‚é€šè¿‡eventï¼Œgodä¼šç«‹å³çŸ¥é“ä¸€ä¸ªè¿›ç¨‹æ˜¯å¦å­˜åœ¨ã€‚å¯¹é‚£äº›ç³»ç»Ÿæ²¡æœ‰eventæ”¯æŒçš„ï¼Œgodä½¿ç”¨pollingæœºåˆ¶ã€‚è¿™ä¸ªéƒ¨åˆ†çš„æ•´ä¸ªè¾“å‡ºå¦‚ä¸‹ï¼š

å¯åŠ¨godåï¼Œä½ å›çœ‹è§ä¸€äº›ä¾‹å¦‚ä»¥ä¸‹çš„è¾“å‡ºï¼š
<pre class="highlight plaintext"># Events

I [2011-12-10 15:24:34]  INFO: Loading simple.god
I [2011-12-10 15:24:34]  INFO: Syslog enabled.
I [2011-12-10 15:24:34]  INFO: Using pid file directory: /Users/tom/.god/pids
I [2011-12-10 15:24:34]  INFO: Started on drbunix:///tmp/god.17165.sock
I [2011-12-10 15:24:34]  INFO: simple move 'unmonitored' to 'init'
I [2011-12-10 15:24:34]  INFO: simple moved 'unmonitored' to 'init'
I [2011-12-10 15:24:34]  INFO: simple [trigger] process is not running (ProcessRunning)
I [2011-12-10 15:24:34]  INFO: simple move 'init' to 'start'
I [2011-12-10 15:24:34]  INFO: simple start: ruby /Users/tom/dev/mojombo/god/simple.rb
I [2011-12-10 15:24:34]  INFO: simple moved 'init' to 'start'
I [2011-12-10 15:24:34]  INFO: simple [trigger] process is running (ProcessRunning)
I [2011-12-10 15:24:34]  INFO: simple move 'start' to 'up'
I [2011-12-10 15:24:34]  INFO: simple registered 'proc_exit' event for pid 23298
I [2011-12-10 15:24:34]  INFO: simple moved 'start' to 'up'

# Polls

I [2011-12-07 09:40:18]  INFO: Loading simple.god
I [2011-12-07 09:40:18]  INFO: Syslog enabled.
I [2011-12-07 09:40:18]  INFO: Using pid file directory: /Users/tom/.god/pids
I [2011-12-07 09:40:18]  INFO: Started on drbunix:///tmp/god.17165.sock
I [2011-12-07 09:40:18]  INFO: simple move 'unmonitored' to 'up'
I [2011-12-07 09:40:18]  INFO: simple moved 'unmonitored' to 'up'
I [2011-12-07 09:40:18]  INFO: simple [trigger] process is not running (ProcessRunning)
I [2011-12-07 09:40:18]  INFO: simple move 'up' to 'start'
I [2011-12-07 09:40:18]  INFO: simple start: ruby /Users/tom/dev/mojombo/god/simple.rb
I [2011-12-07 09:40:19]  INFO: simple moved 'up' to 'up'
I [2011-12-07 09:40:19]  INFO: simple [ok] process is running (ProcessRunning)
I [2011-12-07 09:40:24]  INFO: simple [ok] process is running (ProcessRunning)
I [2011-12-07 09:40:29]  INFO: simple [ok] process is running (ProcessRunning)
</pre>
ä½ å¯ä»¥çœ‹è§godå¯åŠ¨äº†ï¼Œæ³¨æ„åˆ°simpleæ²¡æœ‰åœ¨è¿è¡Œï¼Œå¯åŠ¨å®ƒï¼Œç„¶åæ¯éš”5åˆ†é’Ÿæ£€æŸ¥ä¸€ä¸‹ç¡®ä¿simpleè¿è¡Œæ­£å¸¸ã€‚å‡å¦‚ä½ æƒ³çœ‹è§godçš„é­”åŠ›ï¼Œkill simpleçš„è¿›ç¨‹ã€‚ä½ ä¼šå‘ç°ç±»ä¼¼å¦‚ä¸‹çš„è¾“å‡ºï¼š
<pre class="highlight plaintext"># Events

I [2011-12-10 15:33:38]  INFO: simple [trigger] process 23416 exited (ProcessExits)
I [2011-12-10 15:33:38]  INFO: simple move 'up' to 'start'
I [2011-12-10 15:33:38]  INFO: simple deregistered 'proc_exit' event for pid 23416
I [2011-12-10 15:33:38]  INFO: simple start: ruby /Users/tom/dev/mojombo/god/simple.rb
I [2011-12-10 15:33:38]  INFO: simple moved 'up' to 'start'
I [2011-12-10 15:33:38]  INFO: simple [trigger] process is running (ProcessRunning)
I [2011-12-10 15:33:38]  INFO: simple move 'start' to 'up'
I [2011-12-10 15:33:38]  INFO: simple registered 'proc_exit' event for pid 23601
I [2011-12-10 15:33:38]  INFO: simple moved 'start' to 'up'

# Polls

I [2011-12-07 09:54:59]  INFO: simple [ok] process is running (ProcessRunning)
I [2011-12-07 09:55:04]  INFO: simple [ok] process is running (ProcessRunning)
I [2011-12-07 09:55:09]  INFO: simple [trigger] process is not running (ProcessRunning)
I [2011-12-07 09:55:09]  INFO: simple move 'up' to 'start'
I [2011-12-07 09:55:09]  INFO: simple start: ruby /Users/tom/dev/mojombo/god/simple.rb
I [2011-12-07 09:55:09]  INFO: simple moved 'up' to 'up'
I [2011-12-07 09:55:09]  INFO: simple [ok] process is running (ProcessRunning)
I [2011-12-07 09:55:14]  INFO: simple [ok] process is running (ProcessRunning)
</pre>
ä¿æŒè¿›ç¨‹å¯åŠ¨æ˜¯å¥½çš„ï¼Œä½†æ˜¯å‡å¦‚èƒ½å¤Ÿä¿è¯æˆ‘ä»¬çš„è¿›ç¨‹è¡¨ç°è‰¯å¥½ï¼Œå½“èµ„æºè¶…è¿‡æˆ‘ä»¬çš„è®¾ç½®ï¼Œé‡æ–°å¯åŠ¨è¿›ç¨‹å°†æ›´å¥½ã€‚é€šè¿‡æ·»åŠ ä¸€ç‚¹æ¡ä»¶ï¼Œå½“å†…å­˜æˆ–è€…CPUè¶…è¿‡æˆ‘ä»¬è®¾å®šçš„é™åˆ¶ï¼Œæˆ‘ä»¬èƒ½å¤Ÿå®¹æ˜“åœ°è®©æˆ‘ä»¬çš„è¿›ç¨‹é‡å¯ã€‚ç¼–è¾‘simple.godé…ç½®æ–‡ä»¶å¦‚ä¸‹ï¼š
<pre class="lang:ruby decode:true">God.watch do |w|
  w.name = 'simple'
  w.start = "ruby /full/path/to/simple.rb"
  w.keepalive( :memory_max =&gt; 150.megabytes,
               :cpu_max =&gt; 50.percent)
end</pre>
è¿™é‡Œæˆ‘åœ¨keepaliveå‘½ä»¤ä¸­ä½¿ç”¨äº† :memory_max é€‰é¡¹ã€‚ ç°åœ¨ï¼Œå‡å¦‚è¿›ç¨‹çš„å†…å­˜ç”¨é‡è¶…è¿‡150Mï¼Œ godå°±ä¼šé‡å¯ä»–ã€‚ç›¸ä¼¼åœ°ï¼Œé€šè¿‡è®¾ç½® :cpu_max, å‡å¦‚CPUçš„ä½¿ç”¨è¶…è¿‡50%ï¼Œgodä¹Ÿä¼šé‡å¯å®ƒã€‚ é»˜è®¤è¿™äº›å±æ€§æ¯éš”30ç§’æ£€æŸ¥ä¸€æ¬¡ï¼Œå‡å¦‚äº”ä¸ªæ¡ä»¶ä¸­æ»¡è¶³ä¸‰ä¸ªï¼Œåˆ™ä¼šæ‰§è¡Œã€‚è¿™é˜²æ­¢äº†è¿›ç¨‹å› ä¸ºæš‚æ—¶çš„èµ„æºå³°å€¼å¯¼è‡´é‡å¯ã€‚

ä¸ºäº†æµ‹è¯•è¿™ä¸ªç‰¹æ€§ï¼Œä¿®æ”¹ä½ çš„simple.rbæœåŠ¡å™¨è„šæœ¬ä½¿å¾—å¼•èµ·å†…å­˜æ³„éœ²ï¼š
<pre class="lang:ruby decode:true">data = ''
loop do
  puts 'Hello'
  100000.times { data &lt;&lt; 'x' }
end</pre>
æŒ‰Ctrl-Cç»“æŸgodã€‚æ³¨æ„åˆ°ä½ çš„simpleè¿›ç¨‹ä¾ç„¶åœ¨è¿è¡Œã€‚ç”¨åˆšæ‰çš„æ–¹å¼å†æ¬¡å¯åŠ¨godã€‚ç°åœ¨ä»£æ›¿äº†å¯åŠ¨simpleè¿›ç¨‹ï¼Œgodç›‘æµ‹åˆ°simpleè¿è¡Œï¼Œç®€å•çš„åˆ‡æ¢åˆ°upçŠ¶æ€ã€‚
<pre class="highlight plaintext"># Events

I [2011-12-10 15:36:00]  INFO: Loading simple.god
I [2011-12-10 15:36:00]  INFO: Syslog enabled.
I [2011-12-10 15:36:00]  INFO: Using pid file directory: /Users/tom/.god/pids
I [2011-12-10 15:36:00]  INFO: Started on drbunix:///tmp/god.17165.sock
I [2011-12-10 15:36:00]  INFO: simple move 'unmonitored' to 'init'
I [2011-12-10 15:36:00]  INFO: simple moved 'unmonitored' to 'init'
I [2011-12-10 15:36:00]  INFO: simple [trigger] process is running (ProcessRunning)
I [2011-12-10 15:36:00]  INFO: simple move 'init' to 'up'
I [2011-12-10 15:36:00]  INFO: simple registered 'proc_exit' event for pid 23601
I [2011-12-10 15:36:00]  INFO: simple moved 'init' to 'up'

# Polls

I [2011-12-07 14:50:46]  INFO: Loading simple.god
I [2011-12-07 14:50:46]  INFO: Syslog enabled.
I [2011-12-07 14:50:46]  INFO: Using pid file directory: /Users/tom/.god/pids
I [2011-12-07 14:50:47]  INFO: Started on drbunix:///tmp/god.17165.sock
I [2011-12-07 14:50:47]  INFO: simple move 'unmonitored' to 'up'
I [2011-12-07 14:50:47]  INFO: simple moved 'unmonitored' to 'up'
I [2011-12-07 14:50:47]  INFO: simple [ok] process is running (ProcessRunning)

</pre>
ä¸ºäº†è®©æˆ‘ä»¬çš„simpleæœåŠ¡è¿è¡Œï¼Œæˆ‘ä»¬é‡æ–°å¯åŠ¨simpleï¼š
<pre class="highlight plaintext"> $ god restart simple 
</pre>
é€šè¿‡æ—¥å¿—ä½ å¯ä»¥çœ‹è§godç»“æŸäº†simpleè¿›ç¨‹å¹¶é‡æ–°å¯åŠ¨äº†ï¼š
<pre class="highlight plaintext"># Events

I [2011-12-10 15:38:13]  INFO: simple move 'up' to 'restart'
I [2011-12-10 15:38:13]  INFO: simple deregistered 'proc_exit' event for pid 23601
I [2011-12-10 15:38:13]  INFO: simple stop: default lambda killer
I [2011-12-10 15:38:13]  INFO: simple sent SIGTERM
I [2011-12-10 15:38:14]  INFO: simple process stopped
I [2011-12-10 15:38:14]  INFO: simple start: ruby /Users/tom/dev/mojombo/god/simple.rb
I [2011-12-10 15:38:14]  INFO: simple moved 'up' to 'restart'
I [2011-12-10 15:38:14]  INFO: simple [trigger] process is running (ProcessRunning)
I [2011-12-10 15:38:14]  INFO: simple move 'restart' to 'up'
I [2011-12-10 15:38:14]  INFO: simple registered 'proc_exit' event for pid 23707
I [2011-12-10 15:38:14]  INFO: simple moved 'restart' to 'up'

# Polls

I [2011-12-07 14:51:13]  INFO: simple [ok] process is running (ProcessRunning)
I [2011-12-07 14:51:13]  INFO: simple move 'up' to 'restart'
I [2011-12-07 14:51:13]  INFO: simple stop: default lambda killer
I [2011-12-07 14:51:13]  INFO: simple sent SIGTERM
I [2011-12-07 14:51:14]  INFO: simple process stopped
I [2011-12-07 14:51:14]  INFO: simple start: ruby /Users/tom/dev/mojombo/god/simple.rb
I [2011-12-07 14:51:14]  INFO: simple moved 'up' to 'up'
I [2011-12-07 14:51:14]  INFO: simple [ok] process is running (ProcessRunning)

</pre>
Godç°åœ¨å¼€å§‹æŠ¥å‘Šå†…å­˜å’ŒCPUçš„ä½¿ç”¨æƒ…å†µ
<pre class="highlight plaintext"># Events and Polls

I [2011-12-07 14:54:37]  INFO: simple [ok] process is running (ProcessRunning)
I [2011-12-07 14:54:37]  INFO: simple [ok] memory within bounds [2032kb] (MemoryUsage)
I [2011-12-07 14:54:37]  INFO: simple [ok] cpu within bounds [0.0%%] (CpuUsage)
I [2011-12-07 14:54:42]  INFO: simple [ok] process is running (ProcessRunning)
I [2011-12-07 14:54:42]  INFO: simple [ok] memory within bounds [2032kb, 13492kb] (MemoryUsage)
I [2011-12-07 14:54:42]  INFO: simple [ok] cpu within bounds [0.0%%, *99.7%%] (CpuUsage)
I [2011-12-07 14:54:47]  INFO: simple [ok] process is running (ProcessRunning)
I [2011-12-07 14:54:47]  INFO: simple [ok] memory within bounds [2032kb, 13492kb, 25568kb] (MemoryUsage)
I [2011-12-07 14:54:47]  INFO: simple [ok] cpu within bounds [0.0%%, *99.7%%, *100.0%%] (CpuUsage)
I [2011-12-07 14:54:52]  INFO: simple [ok] process is running (ProcessRunning)
I [2011-12-07 14:54:52]  INFO: simple [ok] memory within bounds [2032kb, 13492kb, 25568kb, 37556kb] (MemoryUsage)
I [2011-12-07 14:54:52]  INFO: simple [trigger] cpu out of bounds [0.0%%, *99.7%%, *100.0%%, *98.4%%] (CpuUsage)
I [2011-12-07 14:54:52]  INFO: simple move 'up' to 'restart
</pre>
åœ¨æœ€åçš„ä¸€è¡Œï¼Œä½ èƒ½çœ‹è§CPUçš„ç”¨é‡å·²ç»è¶…è¿‡äº†50%ä¸‰æ¬¡äº†ï¼Œgodé‡æ–°å¯åŠ¨äº†è¿›ç¨‹ã€‚godä¼šæŒç»­åœ°ç›‘æµ‹simpleè¿›ç¨‹ï¼Œåªè¦godåœ¨è¿è¡Œï¼Œè¿›ç¨‹å°±ä¼šè¢«ä¸€ç›´ç›‘æ§ã€‚

ç°åœ¨ï¼Œä½ ç»“æŸgodä¹‹å‰ï¼Œè®©æˆ‘ä»¬å…ˆé€šè¿‡godç»“æŸsimpleæœåŠ¡ã€‚åœ¨ä¸€ä¸ªæ–°çš„ç»ˆç«¯ï¼Œè¾“å…¥ä»¥ä¸‹å‘½ä»¤ï¼š
<pre class="highlight plaintext"> $ god stop simple 
</pre>
ä½ åº”è¯¥çœ‹è§å¦‚ä¸‹è¾“å‡ºï¼š
<pre class="highlight plaintext">Sending 'stop' command

The following watches were affected:
   simple

</pre>
åœ¨godè¿è¡Œçš„ç»ˆç«¯ï¼Œä½ ä¼šçœ‹è§å‘ç”Ÿäº†ä»€ä¹ˆï¼š
<pre class="highlight plaintext"># Events

I [2011-12-10 15:41:04]  INFO: simple stop: default lambda killer
I [2011-12-10 15:41:04]  INFO: simple sent SIGTERM
I [2011-12-10 15:41:05]  INFO: simple process stopped
I [2011-12-10 15:41:05]  INFO: simple move 'up' to 'unmonitored'
I [2011-12-10 15:41:05]  INFO: simple deregistered 'proc_exit' event for pid 23707
I [2011-12-10 15:41:05]  INFO: simple moved 'up' to 'unmonitored'

# Polls

I [2011-12-07 09:59:59]  INFO: simple [ok] process is running (ProcessRunning)
I [2011-12-07 10:00:04]  INFO: simple [ok] process is running (ProcessRunning)
I [2011-12-07 10:00:07]  INFO: simple stop: default lambda killer
I [2011-12-07 10:00:07]  INFO: simple sent SIGTERM
I [2011-12-07 10:00:08]  INFO: simple process stopped
I [2011-12-07 10:00:08]  INFO: simple move 'up' to 'unmonitored'
I [2011-12-07 10:00:08]  INFO: simple moved 'up' to 'unmonitored'

</pre>
ç°åœ¨ï¼Œä½ å¯ä»¥è‡ªç”±çš„æŒ‰Ctrlâ€”Cé€€å‡ºgodäº†ã€‚çƒ­çƒˆç¥è´ºï¼ä½ å·²ç»æµ‹è¯•äº†ä¸€égodï¼Œä¹Ÿå·²ç»çœ‹è§godæ˜¯å¤šä¹ˆå®¹æ˜“çš„è®©ä½ çš„è¿›ç¨‹ä¸€ç›´è¿è¡Œäº†ã€‚

ä¸è¿‡è¿™åªæ˜¯ä¸ªå¼€å§‹ã€‚åœ¨å®é™…åº”ç”¨ä¸­ï¼Œ*keepalive* å‘½ä»¤æ˜¯ä¸€ä¸ªæ–¹ä¾¿çš„æ–¹æ³•ï¼Œä½¿ç”¨äº†å¯ä»¥ç›´æ¥ä½¿ç”¨çš„æ›´é«˜çº§çš„äº‹åŠ¡å’Œæ¡ä»¶æ„é€ ã€‚ä½ å¯ä»¥é…ç½®è®¸å¤šä¸åŒçš„æ¡ä»¶ï¼Œå½“CPUæˆ–è€…å†…å­˜ä½¿ç”¨å¤ªå¤šï¼Œç£ç›˜è¶…è¿‡ä¸‹é™ï¼Œå½“ä¸€ä¸ªæŒ‡å®šçš„URLè¿”å›é”™è¯¯ä»£ç ï¼Œç­‰ç­‰ã€‚å¦å¤–ï¼Œä½ å¯ä»¥å†™è‡ªå·±çš„è‡ªå®šä¹‰æ¡ä»¶ï¼Œç„¶ååœ¨é…ç½®æ–‡ä»¶é‡Œä½¿ç”¨å®ƒã€‚ä¼´éšç€å¤æ‚çš„å’Œå¯æ‰©å±•çš„é€šçŸ¥ä½“ç³»ï¼Œå¯ä»¥æ§åˆ¶è®¸å¤šä¸åŒçš„ç”Ÿå‘½å‘¨æœŸã€‚

ç»§ç»­é˜…è¯»æ‰¾å‡ºgodä¸åŒäºå…¶ä»–ç›‘æµ‹ç³»ç»Ÿçš„åœ°æ–¹ï¼Œä»¥åŠå®ƒæ€ä¹ˆèƒ½å¸®åŠ©ä½ è§£å†³è®¸å¤šè¿›ç¨‹ç›‘æ§å’Œæ§åˆ¶é—®é¢˜ã€‚

###ç”¨Rubyå†™é…ç½®æ–‡ä»¶
æ—¢ç„¶ä½ å·²ç»çŸ¥é“æ€ä¹ˆä½¿ç”¨godï¼Œè®©æˆ‘ä»¬çœ‹çœ‹godæ›´å¼ºå¤§çš„ä¸€é¢å§ã€‚å†è¯´ä¸€æ¬¡ï¼Œæœ€å¥½çš„å­¦ä¹ æ–¹æ³•æ˜¯é€šè¿‡ç¤ºä¾‹ã€‚ä¸‹é¢è¿™ä¸ªé…ç½®æ–‡ä»¶æ˜¯æˆ‘åœ¨gravatar.comä¿è¯mongrelsè¿è¡Œä½¿ç”¨çš„é…ç½®æ–‡ä»¶ã€‚
<pre class="lang:ruby decode:true">RAILS_ROOT = "/Users/tom/dev/gravatar2"

%w{8200 8201 8202}.each do |port|
  God.watch do |w|
    w.name = "gravatar2-mongrel-#{port}"

    w.start = "mogrel_rails start -c #{RAILS_ROOT} -p #{port} \
      -P #{RAILS_ROOT}/log.mogrel.#{port}.pid -d"
    w.stop = "morgrel_rails stop -P #{RAILS_ROOT}/log/mogrel.#{port}.pid"
    w.restart = "mongrel_rails restart -P #{RAILS_ROOT}/log/mogrel.#{port}.pid"

    w.pid_file = File.join(RAILS_ROOT, "log/mogrel.#{port}.pid")

    w.behavior(:clean_pid_file)

    w.start_if do |start|
      start.condition(:process_running) do |c|
        c.inteval = 5.seconds
        c.running = false
      end
    end

    w.restart_if do |restart|
      restart.condition(:memory_usage) do |c|
       c.above = 150.megabytes
       c.times = [3, 5] # 3 out of 5 intevals
      end

      restart.condition(:cpu_usage) do |c|
        c.above = 50.percent
        c.times = 5
      end
    end

    #lifecycle
    w.lifecycle do |on|
     on.condition(:flapping) do |c|
       c.to_state = [:start, :restart]
       c.times = 5
       c.within = 5.minute
       c.transition = :unmonitored
       c.retry_in = 10.minutes
       c.retry_times = 5
       c.retry_within = 2.hours
     end
    end
   end
  end</pre>
æ–°æ‰‹æ˜¯ä¸æ˜¯ä¸€ä¸‹å­å“è’™äº†ï¼Ÿæ‰€ä»¥æˆ‘æŠŠå®ƒæ‹†æ•£äº†è§£é‡Šæ¯ä¸€éƒ¨åˆ†çš„ä½œç”¨
<pre class="lang:ruby decode:true">RAILS_ROOT = "/var/www/gravatar2/current"</pre>
åœ¨è¿™é‡Œæˆ‘è®¾ç½®äº†ä¸€ä¸ªå¸¸é‡ï¼Œç”¨äºæ•´ä¸ªæ–‡ä»¶ã€‚ä¿æŒRAILS_ROOTçš„å€¼æ˜¯ä¸€ä¸ªå¸¸é‡ä½¿å¾—è„šæœ¬å¾ˆå®¹æ˜“é€‚åˆå…¶ä»–åº”ç”¨ã€‚å› ä¸ºè¿™ä¸ªé…ç½®æ–‡ä»¶æ˜¯Rubyä»£ç ï¼Œæˆ‘å¯ä»¥è®¾ç½®ä»»ä½•å˜é‡æˆ–è€…å¸¸é‡ï¼Œè¿™æ ·å¯ä»¥ä½¿å¾—é…ç½®æ›´ç®€å•ï¼Œæ›´å®¹æ˜“å·¥ä½œã€‚
<pre class="lang:ruby decode:true">%w{8200 8210 8202}.each do |port|
  ...
end</pre>
å› ä¸ºé…ç½®æ–‡ä»¶æ˜¯ç”¨Rubyå†™çš„ï¼Œæˆ‘ä»¬èƒ½æ„é€ å¾ªç¯å’Œå…¶ä»–çœ‹èµ·æ¥ä¸å¯èƒ½çš„æ™ºèƒ½çš„ä¸œä¸œï¼Œå±±ä¸€æ ·å¤šå¾—è¿è¡Œé…ç½®æ–‡ä»¶ã€‚æˆ‘éœ€è¦ç›‘è§†mongrelï¼Œ æ‰€ä»¥æˆ‘ç®€å•çš„å¾ªç¯ä»–ä»¬çš„ç«¯å£å·ï¼Œæ¶ˆé™¤é‡å¤ï¼Œä½¿å¾—æˆ‘å¾—ç”Ÿæ´»æ›´å®¹æ˜“ã€‚
<pre class="lang:ruby decode:true">God.watch do |w|
  w.name = "gravatar2-mongrel-#{port}"
  w.start = "mongrel_rails start -c #{RAILS_ROOT} -P #{port}  \
         -P #{RAILS_ROOT}/log/mongrel.#{port}.pid -d"
  w.stop = "morgrel_rails stop -P #{RAILS_ROOT}/log/mongrel.#{port}.pid"
  w.restart = "mongrel_rails restart -P #{RAILS_ROOT}/log/mongrel.#{port}.pid"

  w.pid_file = File.join(RAILS_ROOT, "log/mongrel.#{port}.pid")

  ...
end</pre>
watchä»£è¡¨ä¸€ä¸ªç®€å•çš„è¿›ç¨‹ï¼ŒåŒ…æ‹¬start, stop, å’Œ/æˆ–restartæ“ä½œã€‚åªè¦ä½ å–œæ¬¢ï¼Œä½ å°±å¯ä»¥å®šä¹‰watcheã€‚ åœ¨ä¸Šä¾‹ä¸­ï¼Œæˆ‘å·²ç»æœ‰ä¸€äº›railså®ä¾‹è¿è¡Œåœ¨mongrelä¸­ï¼Œæˆ‘éœ€è¦mongrelä¸€ç›´è¿è¡Œã€‚æ¯ä¸ªwatchæœ‰ä¸€ä¸ªç‹¬ç‰¹çš„åå­—ä»¥ä¾¿åœ¨åé¢çš„æ“ä½œä¸­è¯†åˆ«ã€‚startå’Œstopå±æ€§ç”¨æ¥æŒ‡å®šå¼€å§‹å’Œç»“æŸè¿›ç¨‹çš„å‘½ä»¤ã€‚å‡å¦‚restartæ²¡æœ‰è®¾ç½®ï¼Œrestartç”¨ä¸€ä¸ªstopå’Œä¸€ä¸ªstartä»£è¡¨ã€‚å¯é€‰çš„graceå±æ€§è®¾ç½®äº†é‡ç½®æ™®é€šç›‘è§†æ“ä½œä»¥å‰ï¼Œstart/stop/restartå‘½ä»¤ç­‰å¾…çš„æ—¶é—´ã€‚å‡å¦‚ä½ æ­£ç›‘è§†çš„è¿›ç¨‹æ˜¯ä¸€ä¸ªåå¤©è¿›ç¨‹ï¼ˆæˆ‘çš„ä¹Ÿæ˜¯ï¼‰ï¼Œä½ éœ€è¦è®¾ç½®pid_fileå±æ€§ã€‚
<pre class="lang:ruby decode:true">w.behavior(:clean_pid_file)</pre>
behavioå…è®¸ä½ ä¼´éšç€start/stop/restartæ‰§è¡Œé¢å¤–çš„å‘½ä»¤ã€‚åœ¨æˆ‘ä»¬çš„ä¾‹å­é‡Œï¼Œå‡å¦‚è¿›ç¨‹æ­»äº†ï¼Œå®ƒä¼šç•™ä¸‹PIDæ–‡ä»¶ã€‚å‡å¦‚ä¸‹æ¬¡é‡æ–°å¯åŠ¨è¿™ä¸ªç¨‹åºï¼Œå°±ä¼šå¯åŠ¨å¤±è´¥ï¼Œæç¤ºPIDæ–‡ä»¶å·²ç»å­˜åœ¨ã€‚æ‰€ä»¥å¯åŠ¨ç¨‹åºæ—¶ï¼Œæˆ‘ä»¬æƒ³å…ˆæ¸…é™¤PIDæ–‡ä»¶ã€‚å†…å»ºçš„clean_pid_fileä¼šæ¸…é™¤ã€‚
<pre class="lang:ruby decode:true  ">w.start_if do |start|
    start.condition(:process_running) do |c|
      c.interval = 5.seconds
      c.running = false
    end
  end</pre>
watchåŒ…å«ç”±å¯æ‰§è¡Œçš„åŠ¨ä½œç»„æˆçš„æ¡ä»¶åº”è¯¥è¿”å›trueã€‚ æˆ‘ç”¨start_ifå—å¼€å§‹ï¼Œè¿™ä¸ªå—åŒ…å«ä¸€ä¸ªç®€å•çš„æ¡ä»¶ã€‚é€šè¿‡ç”¨ä¸€ä¸ªè¯†åˆ«å­—ç¬¦è°ƒç”¨conditionæ¡ä»¶æ¥æè¿°conditionï¼Œè¿™ä¸ªä¾‹å­ä¸­æ˜¯:process_running. æ¯ä¸ªæ¡ä»¶æè¿°ä¸€ä¸ªpollé—´éš”ï¼Œè¿™ä¸ªé—´éš”å°†è¦†ç›–é»˜è®¤çš„é—´éš”ã€‚è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘æƒ³è¦æ¯ä¸ª5ç§’é’Ÿæ£€æŸ¥ä¸€æ¬¡è¿›ç¨‹ï¼Œè€Œä¸æ˜¯åƒå…¶ä»–conditionä¸€æ ·ç”¨30ç§’é—´éš”ã€‚è®¾ç½®condition pollçš„é—´éš”ä½¿å¾—è¿è¡Œæ¯”ä¸å¤ªä¸¥æ ¼çš„æµ‹è¯•ï¼ˆå¦‚:memory_usageå’Œ:cpu_usageï¼‰æ›´é¢‘ç¹å¾—ä¸¥æ ¼æµ‹è¯•æˆä¸ºå¯èƒ½ï¼ˆå¦‚:process_running).
<pre class="lang:ruby decode:true">w.restart_if do |restart|
    restart.condition(:memory_usage) do |c|
      c.above = 150.megabytes
      c.times = [3, 5]
    end

    ...
  end</pre>
å’Œstart_ifç±»ä¼¼ï¼Œrestart_ifå‘½ä»¤ç»„åˆconditionï¼Œç„¶åè§¦å‘restartã€‚memory_usageæ¡ä»¶å°†ä¼šå¤±è´¥ï¼Œå‡å¦‚æŒ‡å®šçš„è¿›ç¨‹ä½¿ç”¨äº†å¤ªå¤šçš„å†…å­˜ã€‚æœ€å¤§å…è®¸çš„å†…å­˜é€šè¿‡aboveå±æ€§æ¥æŒ‡å®šï¼ˆä½ å¯ä»¥ç”¨kilobytes, megabytes, æˆ–è€…gibabytesåŠ©æ‰‹ï¼‰ã€‚ä¸ºäº†è§¦å‘restartéœ€è¦è§¦å‘çš„æ¬¡æ•°é€šè¿‡timesè®¾ç½®ã€‚è¿™ä¸ªå¯ä»¥æ˜¯ä¸€ä¸ªæ•´æ•°ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªæ•°ç»„ã€‚æ•´æ•°æ„å‘³ç€å®ƒå¿…é¡»è¿ç»­å¤±è´¥è®¸å¤šæ¬¡è€Œæ•°ç»„[x, y]æ„å‘³ç€å¿…é¡»yæ¬¡ä¸­å¤±è´¥xæ¬¡ã€‚
<pre class="highlight ruby"> <span class="n">w</span><span class="p">.</span><span class="nf">restart_if</span> <span class="k">do</span> <span class="o">|</span><span class="n">restart</span><span class="o">|</span>
   <span class="p">.</span><span class="nf">.</span><span class="o">.</span>

   <span class="n">restart</span><span class="p">.</span><span class="nf">condition</span><span class="p">(</span><span class="ss">:cpu_usage</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">c</span><span class="o">|</span>
     <span class="n">c</span><span class="p">.</span><span class="nf">above</span> <span class="o">=</span> <span class="mi">50</span><span class="p">.</span><span class="nf">percent</span>
     <span class="n">c</span><span class="p">.</span><span class="nf">times</span> <span class="o">=</span> <span class="mi">5</span>
   <span class="k">end</span>
 <span class="k">end</span>
</pre>
ä¸ºäº†åŒæ—¶ç›‘è§†CPUç”¨é‡ï¼Œæˆ‘ä½¿ç”¨äº†cpu_usageæ¡ä»¶ã€‚å½“mongrelçš„cpuç”¨é‡è¿ç»­è¶…è¿‡50%è¶…è¿‡5æ¬¡ï¼Œå®ƒå°†ä¼šé‡å¯ã€‚
<pre class="lang:ruby decode:true">w.lifecycle do |on|
    on.condition(:flapping) do |c|
      c.to_state = [:start, :restart]
      c.times    = 5
      c.within   = 5.minute
      c.transition   = :unmonitored
      c.retry_in     = 10.minutes
      c.retry_times  = 5
      c.retry_within = 2.hours
    end
  end</pre>
åœ¨lifecycleéƒ¨åˆ†ä¸­çš„conditionåªè¦è¿›ç¨‹è¢«ç›‘è§†å°±ä¸€ç›´æ´»åŠ¨ï¼ˆå®ƒä»¬é€šè¿‡çŠ¶æ€çš„æ”¹å˜æ´»åŠ¨ï¼‰ã€‚
:flapping conditionå®ˆæŠ¤é™¤äº†godå¿«é€Ÿå¼€å§‹å’Œé‡å¯ä½ çš„åº”ç”¨çš„è¿™äº›è¾¹ç¼˜çš„çŠ¶æ€çš„å…¶ä»–æƒ…å†µã€‚æ¯”å¦‚æœåŠ¡å™¨é…ç½®å˜åŒ–æˆ–è€…å¤–éƒ¨æœåŠ¡çš„ä¸å¯ç”¨éƒ½å¯èƒ½é€ æˆæˆ‘å¾—è¿›ç¨‹ä¸èƒ½å¯åŠ¨ã€‚é‚£æ ·çš„è¯ï¼Œgodå°†ä¼šä¸€ç›´é‡è¯•å¯åŠ¨æˆ‘çš„è¿›ç¨‹ã€‚:flapping conditionæä¾›äº†ä¸¤ä¸ªæ°´å¹³çš„æ”¾å¼ƒä¸ç¨³å®šè¿›ç¨‹ã€‚å‡å¦‚æˆ‘ç¿»è¯‘ä»¥ä¸Šçš„optionä»£ç ï¼Œé‚£å°±æ˜¯ï¼šå‡å¦‚watchåœ¨5åˆ†é’Ÿé‡Œè¢«å¯åŠ¨æˆ–è€…é‡å¯äº†5æ¬¡ï¼Œç„¶åä¸å†ç›‘è§†å®ƒã€‚ã€‚ã€‚ç„¶å10åˆ†é’Ÿåï¼Œå†æ¬¡ç›‘è§†ä»–çœ‹çœ‹æ˜¯å¦åªæ˜¯ä¸€ä¸ªä¸´æ—¶çš„é—®é¢˜ï¼›å‡å¦‚è¿›ç¨‹åœ¨ä¸¤å°æ—¶é‡Œä¾ç„¶ä¸ç¨³å®šï¼Œç„¶åå½»åº•æ”¾å¼ƒç›‘è§†ã€‚

å°±è¿™æ ·ï¼
<h4>å¼€å§‹å’Œé…ç½®GOD</h4>
å¦‚æœæŠŠgodä½œä¸ºä¸€ä¸ªåå°è¿›ç¨‹ï¼Œåªéœ€è¦æŠŠé…ç½®æ–‡ä»¶çš„è·¯å¾„ä¼ é€’ç»™godï¼ˆä½ éœ€è¦ä½¿ç”¨sudoå‡å¦‚ä½ åœ¨linuxä½¿ç”¨eventæˆ–è€…æƒ³è¦ä½¿ç”¨setuid/setgidï¼‰:

<code>$ sudo god -c /path/to/config.god</code>

å½“ä½ å†™é…ç½®æ–‡ä»¶çš„æ—¶å€™ï¼Œåœ¨å‰å°è¿è¡Œgodè¿™æ ·ä½ èƒ½çœ‹è§logæ¶ˆæ¯ï¼Œå¯èƒ½ä¼šå¾ˆæœ‰å¸®åŠ©ã€‚ä½ å¯ä»¥ï¼š

<code>$ sudo god -c /path/to/config.god -D</code>

ä½ èƒ½å¯åŠ¨ã€é‡å¯ã€åœæ­¢ã€ç›‘æµ‹ã€ä¸ç›‘æµ‹ä½ çš„watchç”¨åŒæ ·çš„å·¥å…·åƒè¿™æ ·ï¼š

<code>$sudo god stop gravatar2-mongrel-8200</code>

###ç›‘æµ‹éåå°è¿›ç¨‹

éœ€è¦ç›‘è§†ä¸€ä¸ªä¸æ˜¯åå°è¿è¡Œçš„è„šæœ¬ï¼Ÿæ²¡é—®é¢˜ï¼ godä¼šä¸ºä½ åå°è¯å¹¶ä¸”è·Ÿè¸ªè¿™ä¸ªè¿›ç¨‹ã€‚å‡å¦‚ä½ æ²¡æœ‰æŒ‡å®šä¸€ä¸ªpid_file,å®ƒä¼šè‡ªåŠ¨åå°è¯å¹¶ä¸”å°†PIDæ–‡ä»¶ä¿å­˜åœ¨/var/run/god.
<pre class="lang:ruby decode:true ">God.pid_file_directory = '/home/tom/pids'

#è‡ªåŠ¨åå°åŒ–å’Œåˆ›å»ºpidæ–‡ä»¶
God.watch do |w|
  w.name = 'mongrel'
  w.pid_file = File.join(RAILS_ROOT, "log/mongrel.pid")

  w.start = "mongrel_rails start -P #{RAILS_ROOT}/log/mongrel.pid -d"

  #...
 end

 #ä¸è‡ªåŠ¨åå°åŒ–
 God.watch do |w|
   w.name = 'worker'
   #w.pid_file = is not set

   w.start = "rake resque:worker"

   #...
 end</pre>
å‡å¦‚ä½ å®æ„¿å°†PIDæ–‡ä»¶ä¿å­˜åœ¨ä¸åŒçš„ä½ç½®ï¼Œä½ å¯ä»¥åœ¨ä½ çš„é…ç½®æ–‡ä»¶é¡¶ç«¯è®¾ç½®ï¼š

<code>God.pid_file_directory = '/home/tom/pids'</code>

ç›®å½•godå¿…é¡»å¯å†™

#ç¾¤ç»„åŒ–WATCH
watchèƒ½è¢«åˆ†é…åˆ°ç»„ã€‚è¿™äº›ç»„å¯ä»¥é€šè¿‡å‘½ä»¤è¡Œä¸€èµ·æ§åˆ¶ã€‚
<pre class="lang:ruby decode:true">God.watch do |w|
  ...
  w.group = 'mongrels'

  ...
end</pre>
ä»¥ä¸Šé…ç½®æ–‡ä»¶å…è®¸ä½ ä½¿ç”¨ä¸€æ¡å‘½ä»¤æ§åˆ¶watchï¼ˆå’Œè¿™ä¸ªç»„é‡Œçš„å…¶ä»–watchï¼‰ï¼š

<code>$ sudo god stop mongrels</code>
<h4>é‡å®šå‘ä½ è¿›ç¨‹çš„STDOUTå’ŒSTDERR</h4>
é»˜è®¤çš„ï¼ŒSTDOUTè¢«å®šå‘è‡³/dev/null. ä¸ºäº†è¿›å…¥è¿™ä¸ªè¾“å‡ºï¼Œä½ å¯ä»¥é‡å®šå‘STDOUTæµåˆ°æ–‡ä»¶æˆ–è€…å‘½ä»¤ã€‚

ä¸ºäº†é‡å®šå‘STDOUTåˆ°æ–‡ä»¶ï¼Œè®¾ç½®logå±æ€§ä¸ºæ–‡ä»¶è·¯å¾„ã€‚è¿™ä¸ªæ–‡ä»¶å°†ä»¥appendæ¨¡å¼å†™å…¥ï¼Œå‡å¦‚ä¸å­˜åœ¨åˆ™åˆ›å»ºå®ƒã€‚
<pre class="lang:ruby decode:true">God.watch do |w|
  ...
  w.log = '/var/log/myprocess.log'
  ...
end</pre>
ä¸ºäº†é‡å®šå‘STDOUTåˆ°å‘½ä»¤ï¼Œè®¾ç½®log_cmdå±æ€§
<pre class="lang:ruby decode:true">God.watch do |w|
  ...
  w.log_cmd = '/usr/bin/logger'
  ...
end</pre>
é»˜è®¤åœ°ï¼ŒSTDERRä¼šé‡å®šå‘åˆ°STDOUTã€‚ä½ ä¹Ÿå¯ä»¥é€šè¿‡è®¾ç½®err_logå’Œerr_log_cmdé‡å®šå‘ä»–åˆ°æ–‡ä»¶æˆ–å‘½ä»¤ã€‚
<h4>æ”¹å˜è¿›ç¨‹çš„UID/GID</h4>
ä½ ä¹Ÿå¯ä»¥æ”¹å˜godè¿è¡Œstart/stop/restartå‘½ä»¤çš„ç”¨æˆ·æˆ–ç¾¤ç»„ã€‚è¿™ä¸ªå¯ä»¥é€šè¿‡è®¾ç½®uidå’Œgidæ¥æ”¹å˜ï¼š
<pre class="lang:ruby decode:true">God.watch do |w|
  ...
  w.uid = 'tom'
  w.gid = 'devs'
  ...
end</pre>
ä»…ä»…å¯¹å­—ç¬¦ä¸²æœ‰æ•ˆï¼Œå¯¹lambdaå‘½ä»¤æ— æ•ˆã€‚
<h4>è®¾ç½®å·¥ä½œç›®å½•</h4>
åœ¨è¿è¡Œä½ çš„è¿›ç¨‹ä¹‹å‰ï¼ŒGod é»˜è®¤ä¼šæŠŠå·¥ä½œç›®å½•è®¾ç½®åˆ° /ã€‚ï¼ˆæ„Ÿè°¢<a class="at_user" title="@kayakjiang" href="https://ruby-china.org/kayakjiang"><i>@</i>kayakjiang</a>ï¼‰
ä½ å¯ä»¥æ”¹å˜è¿™ä¸ªé€šè¿‡è®¾ç½®dirï¼š
<pre class="lang:ruby decode:true">God.watch do |w|
  ...
  w.dir = '/var/www/myapp'
  ...
end</pre>
<h4>è®¾ç½®ç¯å¢ƒå˜é‡</h4>
ä½ å¯ä»¥é€šè¿‡envå±æ€§è®¾ç½®ä»»ä½•æ•°ç›®çš„ç¯å¢ƒå˜é‡ã€‚
<pre class="lang:ruby decode:true">God.watch do |w|
  ...
  w.env = { 'RAILS_ROOT' =&gt; "/var/www/myapp",
            'RAILS_ENV'  =&gt; "production" }

  ...
end</pre>
<h4>ä½¿ç”¨CHROOTæ”¹å˜æ–‡ä»¶ç³»ç»Ÿçš„æ ¹ç›®å½•</h4>
å‡å¦‚ä½ åƒè¦ä½ çš„è¿›ç¨‹è¿è¡Œåœ¨chrootï¼Œç®€å•çš„åœ¨watchä¸Šä½¿ç”¨chrootå±æ€§ã€‚æŒ‡å®šçš„ç›®å½•å¿…é¡»å­˜åœ¨è€Œä¸”æœ‰/dev/null.
<pre class="lang:ruby decode:true">God.watch do |w|
    ...
    w.chroot = '/var/myroot'
    ...
  end</pre>
<h4>Lambdaå‘½ä»¤</h4>
å¦å¤–ç”¨å­—ç¬¦ä¸²æŒ‡å®šstart/stop/restartå‘½ä»¤ï¼ˆä¸ºäº†é€šè¿‡shellæ‰§è¡Œï¼‰ï¼Œä½ ä¹Ÿå¯ä»¥æŒ‡å®šä¸€ä¸ªlambdaã€‚
<pre class="lang:ruby decode:true">God.watch do |w|
  ...
  w.start = lambda { ENV['APACHE'] ? `apachectl -k graceful ` : `lighttpd restart` }
  ...
end</pre>
<h4>è‡ªå®šä¹‰é»˜è®¤çš„åœæ­¢è¿è¡Œlambda</h4>
å‡å¦‚ä½ æ²¡æœ‰æä¾›ä¸€ä¸ªstopå‘½ä»¤ï¼ŒGodä¼šé¦–å…ˆè¯•å›¾é€šè¿‡å‘é€SIGTERMæ¥åœæ­¢ä½ çš„è¿›ç¨‹ã€‚ç„¶åä¸ºäº†è¿›ç¨‹é€€å‡ºç­‰å¾…10ç§’é’Ÿã€‚å‡å¦‚è¿˜æ²¡æœ‰é€€å‡ºï¼Œå®ƒä¼šå‘é€ä¸€ä¸ªSIGKILLä¿¡å·ã€‚ä½ å¯ä»¥è‡ªå®šä¹‰stopä¿¡å·ï¼Œå’Œ/æˆ–è€…é€šè¿‡åœ¨watchä¸Šè®¾ç½®stop_signalå’Œstop_timeoutå±æ€§ã€‚
<pre class="lang:ruby decode:true">God.watch do |w|
    ...
    w.stop_signal = 'QUIT'
    w.stop_timeout = 20.seconds
    ...
  end</pre>
<h4>åŠ è½½å…¶ä»–é…ç½®æ–‡ä»¶</h4>
ä½ å¯ä»¥éšæ„çš„æŠŠgodé…ç½®æ–‡ä»¶åˆ†æˆå‡ ä¸ªæ–‡ä»¶ï¼Œè¿™æ ·ä¼šæ›´å®¹æ˜“ç»„ç»‡æ–‡ä»¶ã€‚ä½ ä¹Ÿå¯ä»¥é€šè¿‡ä½¿ç”¨Rubyçš„loadæ–¹æ³•æ¥åŠ è½½å…¶ä»–çš„é…ç½®æ–‡ä»¶ï¼Œæˆ–è€…ä½¿ç”¨God.load, å®ƒè¿è¡Œä½ ä½¿ç”¨godé£æ ¼çš„è·¯å¾„ï¼š
<pre class="lang:ruby decode:true">#åŠ è½½æ‰€æœ‰çš„godé…ç½®æ–‡ä»¶
God.load "/usr/local.conf/*.god"</pre>
Godç›´åˆ°æ‰€æœ‰çš„é…ç½®æ–‡ä»¶åŠ è½½å®Œæ‰ä¼šå¼€å§‹ç›‘æµ‹æ“ä½œã€‚
<h4>åŠ¨æ€åŠ è½½æ–‡ä»¶è¿›å…¥ä¸€ä¸ªå·²ç»è¿è¡Œçš„god</h4>
Godå…è®¸ä½ åŠ è½½æˆ–è€…é‡æ–°åŠ è½½é…ç½®æ–‡ä»¶è¿›å…¥ä¸€ä¸ªå·²ç»è¿è¡Œçš„å®ä¾‹ã€‚å½“ä½ å‡†å¤‡è¿™æ ·åšå¾—æ—¶å€™ï¼Œæœ‰å‡ ä»¶äº‹æƒ…éœ€è¦è€ƒè™‘ï¼š
<ul>
	<li>å·²ç»å­˜åœ¨çš„watchä¼šè¢«æ–°é…ç½®æ–‡ä»¶é‡Œçš„åŒåçš„watchè¦†ç›–</li>
	<li>æ‰€æœ‰çš„è·¯å¾„å¿…é¡»æ˜¯ç»å¯¹è·¯å¾„æˆ–è€…godè¿è¡Œçš„ç›¸å¯¹è·¯å¾„&lt;/li&gt;
&lt;/ul&gt;
å°†é…ç½®æ–‡ä»¶åŠ è½½è‡³ä¸€ä¸ªæ­£åœ¨è¿è¡Œçš„godï¼Œè¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

<code>$ sudo god load path/to/config.god</code>

åŠ¨æ€åŠ è½½çš„é…ç½®æ–‡ä»¶å¯ä»¥åŒ…å«ä»»ä½•ä¸€ä¸ªæ™®é€šçš„é…ç½®æ–‡ä»¶ï¼Œç„¶è€Œï¼Œå…¨å±€å˜é‡ä¾‹å¦‚God.pid_file_directoryå—å°†å¯èƒ½ä¼šè¢«å¿½è§†ï¼ˆä¼šåœ¨æ—¥å¿—é‡Œäº§ç”Ÿä¸€ä¸ªè­¦å‘Šï¼‰ã€‚
<h4>ä¸ºå•ä¸ªwatchå¾—åˆ°æ—¥å¿—æ–‡ä»¶</h4>
ä»è®¸å¤šæ—¥å¿—é‡Œç­›é€‰æŸä¸ªæŒ‡å®šçš„watchçš„æ—¥å¿—å¯èƒ½è®©äººå€æ„Ÿç‹¼ç‹ˆã€‚ä½ å¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤å¾—åˆ°ä¸€ä¸ªå®æ—¶çš„logï¼š

<code>$ sudo god log local-3000</code>

è¿™æ¡å‘½ä»¤ä¼šå±•ç¤ºlocal-3000çš„watchçš„logï¼Œæ¯ç§’æ›´æ–°ä¸€æ¬¡ã€‚

ä½ ä¹Ÿå¯ä»¥æä¾›ä¸€ä¸ªå’Œä½ çš„watchæƒ³åŒ¹é…çš„ç®€å†™logå‘½ä»¤ã€‚å‡å¦‚ç¢°å·§åŒ¹é…å‡ ä¸ªwatchï¼ŒåŒ¹é…ç¼©å†™å¦‚ä¸‹ï¼š

<code>$ sudo god log 13</code>
<h4>é€šçŸ¥</h4>
Godæœ‰ä¸€ä¸ªå†…å»ºçš„å¯æ‰©å±•çš„é€šçŸ¥æ¡†æ¶ï¼Œè¿™ä½¿å¾—å½“æ¡ä»¶è¢«è§¦å‘æ—¶å‘é€é€šçŸ¥å˜å¾—å¾ˆå®¹æ˜“ã€‚æ¯ä¸ªé€šçŸ¥çš„ç±»å‹æœ‰ä¸€å¥—å¿…é¡»é…ç½®çš„å‚æ•°ã€‚è¿™äº›å‚æ•°é€šè¿‡Contact Defaultså¯èƒ½è¢«è®¾ç½®æˆå…¨å±€çš„ï¼Œæˆ–è€…é€šè¿‡Contactå®ä¾‹è®¾ç½®æˆä¸åŒçš„ã€‚

Contact Defaults - ä¸€äº›ä¸å¯èƒ½æ¯ä¸ªContactéƒ½ä¼šæ”¹å˜çš„å‚æ•°ã€‚ä½ åº”è¯¥é€šè¿‡é»˜è®¤çš„æœºåˆ¶è®¾ç½®é‚£äº›å‚æ•°ã€‚
<pre class="lang:ruby decode:true">God::Contacts::Email.defaults do  |d|
  d.from_email = 'god@example.com'
  d.from_name  = 'God'
  d.delivery_method = :sendmail
end</pre>
Contactå®ä¾‹ - æ¯ä¸ªcontactå¿…é¡»æœ‰ä¸ªä¸€ç‹¬ç‰¹çš„åå­—é›†åˆã€‚ä½ å¯ä»¥åˆ†é…æ¯ä¸ªcontactåˆ°ä¸€ä¸ªç»„ã€‚
<pre class="lang:ruby decode:true">God.contact(:email) do |c|
  c.name   = 'tom'
  c.group  = 'developers'
  c.to_email = 'tom@example.com'
end

God.contact(:email) do |c|
  c.name   =  'vanpelt'
  c.group  =  'developers'
  c.to_email  = 'vanpelt@example.com'
end

God.contact(:email) do |c|
  c.name = 'kevin'
  c.group = 'developers'
  c.to_email = 'kevin@example.com'
end</pre>
Condition Attachment - å½“äº‹ä»¶è§¦å‘æ—¶å‘é€ä¸€ä¸ªæŒ‡å®šçš„é€šçŸ¥ï¼Œç®€å•çš„è®¾ç½®conditionçš„notifyå±æ€§ä¸ºå•ç‹¬çš„contactã€‚
<pre class="lang:ruby decode:true">w.transition(:up, :start) do |on|
  on.condition(:process_exits) do |c|
    c.notify = 'tom'
  end
end</pre>
æœ‰ä¸¤ç§æ–¹æ³•å…·ä½“è¯´æ˜åº”è¯¥å‘é€é€šçŸ¥ã€‚ç¬¬ä¸€ä¸ªï¼Œå®¹æ˜“ç‚¹å¾—æ–¹æ³•å°±æ˜¯ä¸Šé¢çš„è¿™ç§ã€‚æ¯ä¸ªconditionå¯ä»¥å•ç‹¬è®¾ä¸€æ¬¡notifyå±æ€§ï¼Œå½“æ¡ä»¶æ»¡è¶³æ—¶è§¦å‘é€šçŸ¥ã€‚è¿™ä¸ªå€¼å¯ä»¥æ˜¯contactçš„åå­—æˆ–è€…contactçš„ç»„ï¼Œæˆ–è€…ç”±ä»–ä»¬ç»„æˆçš„æ•°ç»„ã€‚
<pre class="lang:ruby decode:true">w.transition(:up, :start) do |on|
  on.condition(:process_exits) do |c|
    c.notify = {:contacts =&gt; ['tom', 'developers'], :priority =&gt;1, :category=&gt; 'product'}
  end
end</pre>
å¦ä¸€ç§æ–¹æ³•å…è®¸ä½ æŒ‡å®šä¼˜å…ˆçº§ï¼ˆpriorityï¼‰å’Œç±»åˆ«ï¼ˆcategoryï¼‰ã€‚é¢å¤–çš„å±æ€§å¯ä»¥æ˜¯ä»»æ„çš„æ•´æ•°æˆ–è€…å­—ç¬¦ä¸²ï¼Œç„¶åä¼ é€’åˆ°é€šçŸ¥å­ç³»ç»Ÿã€‚

ä¸Šé¢çš„é€šçŸ¥å°†ä¼šä»¥ä¸€ä¸ªå’Œä¸‹é¢ç±»ä¼¼çš„é‚®ä»¶é€šçŸ¥ã€‚

From: God &lt;god@example.com&gt;
To: tom &lt;tom@example.com&gt;
Subject: [god] mongrel-8600 [trigger] process exited (ProcessExits)

Message: mongrel-8600 [trigger] process exited (ProcessExits)
Host: candymountain.example.com
Priority: 1
Category: product
<h4>å¯ç”¨çš„é€šçŸ¥æ–¹å¼</h4>
ï¼ˆgodæ”¯æŒCampfire, email, Jabber, Prowl, Scout, Twitterå¤šç§æ–¹å¼ï¼Œè€Œä¸”æ˜“äºæ‰©å±•ï¼Œè¿™é‡Œåªç¿»è¯‘äº†Emailçš„æ–¹å¼ï¼Œå…¶ä»–å¯ä»¥å‰å¾€<a href="http://godrb.com/" target="_blank">å®˜ç½‘</a>è‡ªè¡ŒæŸ¥çœ‹ã€‚ï¼‰
<h4>Email</h4>
å‘é€é€šçŸ¥åˆ°æŒ‡å®šçš„emailåœ°å€
<pre class="lang:ruby decode:true  ">God::Contacts::Email.defaults do |d|
  ...
end

God.conteact(:email) do |c|
   ...
end</pre>
to_email - å­—ç¬¦ä¸²ï¼šå‘é€è‡³è¯¥emailåœ°å€
to_name - å­—ç¬¦ä¸²ï¼šæ¥æ”¶äººçš„åå­—
from_email - å­—ç¬¦ä¸²ï¼šæ¥è‡ªäº
from_name - å­—ç¬¦ä¸²ï¼šæ¥è‡ªäº
delivery_method - ç¬¦å·ï¼šå‘é€çš„æ–¹å¼, [ :smtp | :sendmail ]
é»˜è®¤æ˜¯:smtp

=== SMTP é€‰é¡¹ ( å½“ delivery_method = :smtp) ===
server_host - å­—ç¬¦ä¸²ï¼šSMTPæœåŠ¡å™¨ä¸»æœºåï¼ˆé»˜è®¤æ˜¯ï¼šlocalhost ï¼‰
server_port - æ•´å‹ï¼šSMTPæœåŠ¡å™¨ç«¯å£ï¼ˆé»˜è®¤ä¸º25ï¼‰
server_auth - å¸ƒå°”å‹ï¼š ï¼ˆé»˜è®¤ä¸ºfalseï¼‰

=== SMTP Auth é€‰é¡¹ (å½“ server_auth = true) ===
server_domain -å­—ç¬¦ä¸²ï¼šåŸŸå
server_user -å­—ç¬¦ä¸²ï¼šç”¨æˆ·å
server_password -å­—ç¬¦ä¸²ï¼šå¯†ç 

=== Sendmail é€‰é¡¹ (å½“ delivery_method = :sendmail) ===
sendmail_path -å­—ç¬¦ä¸²ï¼šsendmailçš„è·¯å¾„ï¼ˆé»˜è®¤æ˜¯â€œ/usr/sbin/sendmailâ€ï¼‰
sendmail_args -å­—ç¬¦ä¸²ï¼šsendmailçš„å‚æ•°ï¼ˆé»˜è®¤æ˜¯ â€œ-i -tâ€ï¼‰
</li></ul></h4></h4></li></li></ul></h4>
:ET