---
layout:     post
title:      "Rails中使用elasticsearch全文搜索引擎"
date:       2016-08-11 16:45:22 UTC
author:     "baicai"
catalog: true
tags:
    - 存档
---

<h3>安装好elasticsearch</h3><p><br></p><p><a href="http://www.liubaicai.net/articles/747">http://www.liubaicai.net/articles/747</a>&nbsp;有介绍&lt;/p><p><br></p><h3>首先引入gem</h3><p><br></p><pre style="background-color:#ffffff;color:#000000;font-family:'Menlo';font-size:9.0pt;"><span style="font-style:italic;">gem </span><span style="color:#008000;font-weight:bold;">'elasticsearch-model'<br></span><span style="font-style:italic;">gem </span><span style="color:#008000;font-weight:bold;">'elasticsearch-rails'<br></span><span style="font-style:italic;">gem </span><span style="color:#008000;font-weight:bold;">'elasticsearch-persistence'</span></pre><p>然后新建一个lib/tasks/elasticssearch.rake中&lt;/p><pre style="background-color:#ffffff;color:#000000;font-family:'Menlo';font-size:9.0pt;"><span style="font-style:italic;">require </span><span style="color:#008000;font-weight:bold;">'elasticsearch/rails/tasks/import'</span></pre><h3><br></h3><h3>为数据库表添加索引的迁移</h3><p><br></p><pre style="background-color:#ffffff;color:#000000;font-family:'Menlo';font-size:9.0pt;"><span style="color:#000080;font-weight:bold;">class </span><span style="color:#660e7a;font-weight:bold;font-style:italic;">AddIndexsToArticles </span>&lt; <span style="color:#660e7a;font-weight:bold;font-style:italic;">ActiveRecord</span>::<span style="color:#660e7a;font-weight:bold;font-style:italic;">Migration<br></span><span style="color:#660e7a;font-weight:bold;font-style:italic;">  </span><span style="color:#000080;font-weight:bold;">def </span><span style="color:#0000ff;font-style:italic;">change<br></span><span style="color:#0000ff;font-style:italic;">    </span><span style="font-style:italic;">add_index </span><span style="color:#660e7a;font-weight:bold;">:articles</span>, <span style="color:#660e7a;font-weight:bold;">:title<br></span><span style="color:#660e7a;font-weight:bold;">    </span><span style="font-style:italic;">add_index </span><span style="color:#660e7a;font-weight:bold;">:articles</span>, <span style="color:#660e7a;font-weight:bold;">:content<br></span><span style="color:#660e7a;font-weight:bold;">  </span><span style="color:#000080;font-weight:bold;">end<br></span><span style="color:#000080;font-weight:bold;">end</span></pre><h3><br></h3><h3>扩展model类&lt;/h3><p><br></p><pre style="background-color:#ffffff;color:#000000;font-family:'Menlo';font-size:9.0pt;"><span style="color:#000080;font-weight:bold;">class </span><span style="color:#660e7a;font-weight:bold;font-style:italic;">Article </span>&lt; <span style="color:#660e7a;font-weight:bold;font-style:italic;">ActiveRecord</span>::<span style="color:#660e7a;font-weight:bold;font-style:italic;">Base<br></span><span style="color:#660e7a;font-weight:bold;font-style:italic;">  </span><span style="font-style:italic;">include </span><span style="color:#660e7a;font-weight:bold;font-style:italic;">Elasticsearch</span>::<span style="color:#660e7a;font-weight:bold;font-style:italic;">Model<br></span><span style="color:#660e7a;font-weight:bold;font-style:italic;">  </span><span style="font-style:italic;">include </span><span style="color:#660e7a;font-weight:bold;font-style:italic;">Elasticsearch</span>::<span style="color:#660e7a;font-weight:bold;font-style:italic;">Model</span>::<span style="color:#660e7a;font-weight:bold;font-style:italic;">Callbacks<br></span><span style="color:#660e7a;font-weight:bold;font-style:italic;"><br></span><span style="color:#660e7a;font-weight:bold;font-style:italic;">  </span>mapping <span style="color:#660e7a;font-weight:bold;">dynamic</span>: <span style="color:#000080;font-weight:bold;">false do<br></span><span style="color:#000080;font-weight:bold;">    </span>indexes <span style="color:#660e7a;font-weight:bold;">:title<br></span><span style="color:#660e7a;font-weight:bold;">    </span>indexes <span style="color:#660e7a;font-weight:bold;">:content<br></span><span style="color:#660e7a;font-weight:bold;">  </span><span style="color:#000080;font-weight:bold;">end<br></span><span style="color:#000080;font-weight:bold;">end</span></pre><p>也可以定制json输出的内容，比如关联表数据等</p><pre>def as_indexed_json(options={})
   self.as_json(
     only: [:id, :name, :description, :status],   
     include: { tags: { only: [:name]}}
   )
 end<br></pre><h3><br></h3><h3>执行</h3><p><br></p><pre>rake environment elasticsearch:import:model CLASS='Article' FORCE=y<br></pre><p>最后&lt;/p><p>bundle install &amp; rake db:migrate</p><p><br></p><blockquote><p>就可以愉快的搜索了&lt;/p></blockquote><pre style="background-color:#ffffff;color:#000000;font-family:'Menlo';font-size:9.0pt;"><span style="color:#003c5a;font-style:italic;">articles </span>= <span style="color:#660e7a;font-weight:bold;font-style:italic;">Article</span>.search('苟利国家生死以&apos;).results</pre><p><br></p><p><br></p><p><br></p><p><br></p>